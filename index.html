<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Inventario - Artículos de Oficina</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-database-compat.js"></script>
    <style>
        /* ESTILOS (se mantienen igual que en tu archivo original) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            font-size: 14px;
        }

        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 100%;
            overflow-x: hidden;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h1 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.4rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            opacity: 0.9;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stock-alert {
            background-color: #e74c3c;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }

        .stock-alert.show {
            display: block;
        }

        .main-content {
            display: flex;
            flex: 1;
            flex-direction: column;
        }

        @media (min-width: 768px) {
            .main-content {
                flex-direction: row;
            }
        }

        .sidebar {
            width: 100%;
            background-color: #2c3e50;
            color: white;
            padding: 1rem 0;
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 768px) {
            .sidebar {
                width: 250px;
                min-width: 250px;
            }
        }

        .menu {
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding: 0 1rem;
        }

        @media (max-width: 767px) {
            .menu {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .menu-btn {
                flex: 1;
                min-width: 120px;
                justify-content: center;
            }
        }

        .menu-btn {
            background: none;
            border: none;
            color: #ecf0f1;
            text-align: left;
            padding: 10px 12px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .menu-btn:hover {
            background-color: #34495e;
        }

        .menu-btn.active {
            background-color: #3498db;
            font-weight: 600;
        }

        .menu-divider {
            height: 1px;
            background-color: #4a6278;
            margin: 10px 0;
            width: 100%;
        }

        .export-btn {
            background-color: #27ae60;
        }

        .export-btn:hover {
            background-color: #219653;
        }

        .stats {
            margin-top: auto;
            padding: 1rem;
            background-color: #34495e;
            border-radius: 5px;
            margin: 1rem;
            display: none;
        }

        @media (min-width: 768px) {
            .stats {
                display: block;
            }
        }

        .stats h3 {
            font-size: 1rem;
            margin-bottom: 0.8rem;
            color: #ecf0f1;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.8rem;
        }

        .content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            width: 100%;
        }

        @media (min-width: 768px) {
            .content {
                padding: 1.5rem;
            }
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.4rem;
        }

        h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .filters {
            display: flex;
            gap: 8px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filters input, .filters select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.85rem;
            min-width: 0;
        }

        .filters input:focus, .filters select:focus {
            outline: none;
            border-color: #3498db;
        }

        #searchProduct {
            flex: 2;
            min-width: 150px;
        }

        #filterCategory, #filterDept, #filterDate {
            flex: 1;
            min-width: 120px;
        }

        #clearFilters {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        #clearFilters:hover {
            background-color: #c0392b;
        }

        .table-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            overflow: auto;
            max-height: 500px;
            width: 100%;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        thead {
            background-color: #3498db;
            color: white;
            position: sticky;
            top: 0;
        }

        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 0.85rem;
        }

        tbody tr:hover {
            background-color: #f5f9fc;
        }

        .stock-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .stock-low {
            background-color: #e74c3c;
            animation: pulse 2s infinite;
        }

        .stock-medium {
            background-color: #f39c12;
        }

        .stock-high {
            background-color: #27ae60;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .btn-action {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .btn-edit {
            background-color: #f39c12;
            color: white;
        }

        .btn-delete {
            background-color: #e74c3c;
            color: white;
        }

        .btn-assign {
            background-color: #3498db;
            color: white;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        @media (max-width: 480px) {
            .form-group {
                min-width: 100%;
            }
        }

        .form-group.full-width {
            flex: 100%;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.85rem;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
            font-size: 0.9rem;
            flex: 1;
            justify-content: center;
            min-width: 120px;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background-color: #219653;
        }

        .reports-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .report-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 15px;
            flex: 1;
            min-width: 300px;
        }

        @media (max-width: 767px) {
            .report-card {
                min-width: 100%;
            }
        }

        .report-card.full-width {
            flex: 100%;
        }

        .chart-container {
            height: 250px;
            margin-top: 15px;
            position: relative;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-box {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .stat-box i {
            font-size: 1.5rem;
            color: #3498db;
        }

        .stat-content h4 {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .stat-content p {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .report-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .report-controls select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            min-width: 150px;
            font-size: 0.85rem;
        }

        @media (max-width: 480px) {
            .report-controls select {
                min-width: 100%;
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: #3498db;
            color: white;
            border-radius: 8px 8px 0 0;
        }

        .close-modal {
            font-size: 1.3rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 15px;
        }

        .confirm-modal .modal-body {
            text-align: center;
            padding: 20px 15px;
        }

        .modal-footer {
            padding: 15px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            flex-wrap: wrap;
        }

        footer {
            background-color: #2c3e50;
            color: #ecf0f1;
            text-align: center;
            padding: 1rem;
            font-size: 0.8rem;
        }

        .product-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 15px;
            margin-bottom: 15px;
            border-left: 5px solid #3498db;
        }

        .product-card.low-stock {
            border-left-color: #e74c3c;
        }

        .product-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .product-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: #2c3e50;
        }

        .product-category {
            background-color: #e3f2fd;
            color: #3498db;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
        }

        .product-stock {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .stock-progress {
            height: 8px;
            background-color: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .stock-progress-bar {
            height: 100%;
            background-color: #27ae60;
            transition: width 0.3s;
        }

        .stock-progress-bar.low {
            background-color: #e74c3c;
        }

        .stock-progress-bar.medium {
            background-color: #f39c12;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 5px;
        }
        
        .badge-papeleria {
            background-color: #e3f2fd;
            color: #3498db;
        }
        
        .badge-toner {
            background-color: #e8f5e9;
            color: #27ae60;
        }
        
        .badge-oficina {
            background-color: #fff3cd;
            color: #f39c12;
        }
        
        .badge-electronica {
            background-color: #f3e5f5;
            color: #9b59b6;
        }
        
        .badge-otros {
            background-color: #e9ecef;
            color: #6c757d;
        }
        
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .dashboard-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        
        .dashboard-card i {
            font-size: 2rem;
            color: #3498db;
            margin-bottom: 10px;
        }
        
        .dashboard-card h3 {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .dashboard-card p {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .dashboard-card.warning {
            background-color: #fff3cd;
            border-left: 5px solid #f39c12;
        }
        
        .dashboard-card.danger {
            background-color: #f8d7da;
            border-left: 5px solid #e74c3c;
        }
        
        /* Nuevos estilos para la gestión de unidades */
        .unit-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 3px;
        }
        
        .unit-badge {
            background-color: #e8f4fd;
            color: #3498db;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 5px;
        }
        
        .unit-conversion {
            font-size: 0.75rem;
            color: #7f8c8d;
            font-style: italic;
        }
        
        .stock-details {
            display: flex;
            flex-direction: column;
        }
        
        .stock-total {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .unit-assignment {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border-left: 3px solid #3498db;
        }
        
        .unit-assignment h4 {
            font-size: 0.9rem;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .unit-calc {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .unit-calc input {
            width: 80px;
        }
        
        .unit-result {
            background-color: #e9ecef;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        /* Estilos para departamentos largos */
        .department-select {
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* Estilos para el botón de reposición */
        .btn-reposition {
            background-color: #9b59b6;
            color: white;
        }
        
        .btn-reposition:hover {
            background-color: #8e44ad;
        }

        /* Loading indicator */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .alert-message {
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 5px;
            display: none;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading"></div>
            <p id="loadingText">Inicializando sistema...</p>
        </div>
    </div>

    <div class="container">
        <header>
            <h1><i class="fas fa-boxes"></i> Sistema de Inventario - Artículos de Oficina</h1>
            <div class="header-info">
                <div class="date-time" id="currentDateTime"></div>
                <div class="total-products">Productos: <span id="totalProducts">0</span></div>
                <div class="connection-status" id="connectionStatus">
                    <i class="fas fa-circle" style="color: #ccc;"></i>
                    <span>Inicializando...</span>
                </div>
            </div>
            <div class="stock-alert" id="stockAlert">
                <i class="fas fa-exclamation-triangle"></i> 
                <span id="alertMessage">Hay productos con stock bajo. Verifique el inventario.</span>
            </div>
            <div id="firebaseAlert" class="alert-message alert-error" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Error de conexión con Firebase. Verifique la configuración.</span>
            </div>
        </header>

        <div class="main-content">
            <div class="sidebar">
                <div class="menu">
                    <button class="menu-btn active" data-section="dashboard">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </button>
                    <button class="menu-btn" data-section="inventario">
                        <i class="fas fa-clipboard-list"></i> Inventario
                    </button>
                    <button class="menu-btn" data-section="nuevo-producto">
                        <i class="fas fa-plus"></i> Nuevo Producto
                    </button>
                    <button class="menu-btn" data-section="asignacion">
                        <i class="fas fa-hand-holding"></i> Asignar Material
                    </button>
                    <button class="menu-btn" data-section="movimientos">
                        <i class="fas fa-exchange-alt"></i> Movimientos
                    </button>
                    <button class="menu-btn" data-section="reportes">
                        <i class="fas fa-chart-bar"></i> Reportes
                    </button>
                    <div class="menu-divider"></div>
                    <button class="menu-btn export-btn" id="exportPdf">
                        <i class="fas fa-file-pdf"></i> Exportar PDF
                    </button>
                    <button class="menu-btn export-btn" id="exportExcel">
                        <i class="fas fa-file-excel"></i> Exportar Excel
                    </button>
                    <button class="menu-btn export-btn" id="exportInventoryExcel">
                        <i class="fas fa-file-excel"></i> Inventario Actual
                    </button>
                    <button class="menu-btn" id="loadInitialData" style="background-color: #9b59b6;">
                        <i class="fas fa-database"></i> Cargar Datos Iniciales
                    </button>
                    <button class="menu-btn" id="clearAllData" style="background-color: #e74c3c;">
                        <i class="fas fa-trash-alt"></i> Limpiar Base de Datos
                    </button>
                </div>

                <div class="stats">
                    <h3>Resumen del Inventario</h3>
                    <div class="stat-item">
                        <span>Productos bajos:</span>
                        <strong id="lowStockCount">0</strong>
                    </div>
                    <div class="stat-item">
                        <span>Asignaciones hoy:</span>
                        <strong id="todayAssignments">0</strong>
                    </div>
                    <div class="stat-item">
                        <span>Stock total (unidades):</span>
                        <strong id="totalStock">0</strong>
                    </div>
                    <div class="stat-item">
                        <span>Estado Firebase:</span>
                        <small id="firebaseStatus">Inicializando...</small>
                    </div>
                </div>
            </div>

            <div class="content">
                <!-- Sección Dashboard -->
                <section id="dashboard" class="content-section active">
                    <h2><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
                    
                    <div id="dashboardEmpty" style="text-align: center; padding: 40px; display: none;">
                        <i class="fas fa-database" style="font-size: 48px; color: #ccc; margin-bottom: 20px;"></i>
                        <h3>Base de datos vacía</h3>
                        <p>No hay datos en el inventario. Presiona el botón "Cargar Datos Iniciales" en el menú lateral para comenzar.</p>
                    </div>
                    
                    <div id="dashboardContent" style="display: none;">
                        <div class="dashboard-cards">
                            <div class="dashboard-card">
                                <i class="fas fa-boxes"></i>
                                <h3 id="dashboardTotalProducts">0</h3>
                                <p>Productos en Inventario</p>
                            </div>
                            
                            <div class="dashboard-card warning" id="lowStockCard">
                                <i class="fas fa-exclamation-triangle"></i>
                                <h3 id="dashboardLowStock">0</h3>
                                <p>Productos con Stock Bajo</p>
                            </div>
                            
                            <div class="dashboard-card">
                                <i class="fas fa-hand-holding"></i>
                                <h3 id="dashboardTotalAssignments">0</h3>
                                <p>Asignaciones este Mes</p>
                            </div>
                            
                            <div class="dashboard-card">
                                <i class="fas fa-calculator"></i>
                                <h3 id="dashboardTotalUnits">0</h3>
                                <p>Total Unidades Disponibles</p>
                            </div>
                        </div>
                        
                        <div class="reports-container">
                            <div class="report-card">
                                <h3>Stock por Categoría</h3>
                                <div class="chart-container">
                                    <canvas id="categoryChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="report-card">
                                <h3>Productos con Stock Bajo</h3>
                                <div id="lowStockList">
                                    <p style="text-align: center; color: #666; padding: 20px;">No hay productos con stock bajo</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Sección de Inventario -->
                <section id="inventario" class="content-section">
                    <h2><i class="fas fa-clipboard-list"></i> Inventario de Productos</h2>
                    <div id="inventoryEmpty" style="text-align: center; padding: 40px; display: none;">
                        <i class="fas fa-clipboard-list" style="font-size: 48px; color: #ccc; margin-bottom: 20px;"></i>
                        <h3>Inventario vacío</h3>
                        <p>No hay productos registrados. Agrega productos o carga los datos iniciales.</p>
                    </div>
                    <div id="inventoryContent" style="display: none;">
                        <div class="filters">
                            <input type="text" id="searchProduct" placeholder="Buscar producto...">
                            <select id="filterCategory">
                                <option value="">Todas las Categorías</option>
                                <option value="papeleria">Papelería</option>
                                <option value="oficina">Artículos de Oficina</option>
                                <option value="toner">Toner</option>
                                <option value="electronica">Electrónica</option>
                                <option value="limpieza">Limpieza</option>
                                <option value="otros">Otros</option>
                            </select>
                            <select id="filterStock">
                                <option value="">Todo el Stock</option>
                                <option value="low">Stock Bajo</option>
                                <option value="normal">Stock Normal</option>
                                <option value="alto">Stock Alto</option>
                            </select>
                            <button id="clearFilters"><i class="fas fa-times"></i> Limpiar filtros</button>
                        </div>
                        <div class="table-container">
                            <table id="inventarioTable">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Producto</th>
                                        <th>Categoría</th>
                                        <th>Stock</th>
                                        <th>Unidades Totales</th>
                                        <th>Unidad</th>
                                        <th>Stock Mínimo</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="inventarioTableBody">
                                    <!-- Los productos se cargarán aquí -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Sección de Nuevo Producto -->
                <section id="nuevo-producto" class="content-section">
                    <h2><i class="fas fa-plus"></i> Registrar/Reponer Producto</h2>
                    <form id="nuevoProductoForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="codigoProducto">Código del Producto *</label>
                                <input type="text" id="codigoProducto" placeholder="Ej: OFI-001" required>
                                <small class="unit-conversion">Para reponer, use el código existente</small>
                            </div>
                            <div class="form-group">
                                <label for="nombreProducto">Nombre del Producto *</label>
                                <input type="text" id="nombreProducto" placeholder="Ej: Bolígrafos" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="categoriaProducto">Categoría *</label>
                                <select id="categoriaProducto" required>
                                    <option value="">Seleccione...</option>
                                    <option value="papeleria">Papelería</option>
                                    <option value="oficina">Artículos de Oficina</option>
                                    <option value="toner">Toner</option>
                                    <option value="electronica">Electrónica</option>
                                    <option value="limpieza">Limpieza</option>
                                    <option value="otros">Otros</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="unidadProducto">Unidad de Medida *</label>
                                <select id="unidadProducto" required>
                                    <option value="">Seleccione...</option>
                                    <option value="UND">Unidades</option>
                                    <option value="CAJAS">Cajas</option>
                                    <option value="PAQ">Paquetes</option>
                                    <option value="GALON">Galones</option>
                                    <option value="LT">Litros</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="unidadesPorMedida">Unidades por Medida *</label>
                                <input type="number" id="unidadesPorMedida" min="1" value="1" required>
                                <small class="unit-conversion">Ej: 24 unidades por caja, 100 unidades por paquete</small>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="stockInicial">Stock a Agregar *</label>
                                <input type="number" id="stockInicial" min="0" required>
                                <small class="unit-conversion">En la unidad de medida seleccionada</small>
                            </div>
                            <div class="form-group">
                                <label for="stockMinimo">Stock Mínimo (Alerta) *</label>
                                <input type="number" id="stockMinimo" min="1" value="5" required>
                                <small class="unit-conversion">En la unidad de medida seleccionada</small>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="descripcionProducto">Descripción / Motivo</label>
                                <textarea id="descripcionProducto" rows="3" placeholder="Detalles del producto o motivo de reposición..."></textarea>
                            </div>
                        </div>

                        <div class="form-buttons">
                            <button type="submit" class="btn btn-primary" id="saveProductBtn">
                                <i class="fas fa-save"></i> Guardar Producto
                            </button>
                            <button type="button" class="btn btn-success" id="repositionBtn" style="display: none;">
                                <i class="fas fa-boxes"></i> Reponer Stock
                            </button>
                            <button type="reset" class="btn btn-secondary" id="resetProductBtn">
                                <i class="fas fa-redo"></i> Limpiar
                            </button>
                        </div>
                    </form>
                </section>

                <!-- Sección de Asignación de Material -->
                <section id="asignacion" class="content-section">
                    <h2><i class="fas fa-hand-holding"></i> Asignar Material a Departamentos</h2>
                    <div id="assignEmpty" style="text-align: center; padding: 40px; display: none;">
                        <i class="fas fa-hand-holding" style="font-size: 48px; color: #ccc; margin-bottom: 20px;"></i>
                        <h3>No hay productos disponibles</h3>
                        <p>No hay productos con stock disponible para asignar. Agrega productos primero.</p>
                    </div>
                    <div id="assignContent" style="display: none;">
                        <form id="asignacionForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="productoAsignar">Producto *</label>
                                    <select id="productoAsignar" required>
                                        <option value="">Seleccione...</option>
                                        <!-- Los productos se cargarán dinámicamente -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="stockDisponible">Stock Disponible (Unidades)</label>
                                    <input type="text" id="stockDisponible" readonly style="background-color: #f5f5f5;">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="departamentoAsignar">Departamento *</label>
                                    <select id="departamentoAsignar" class="department-select" required>
                                        <option value="">Seleccione...</option>
                                        <option value="Administración">Administración</option>
                                        <option value="Tesorería">Tesorería</option>
                                        <option value="RRHH">RRHH</option>
                                        <option value="Flota">Flota</option>
                                        <option value="Almacén">Almacén</option>
                                        <option value="Head End">Head End</option>
                                        <option value="Seguridad Laboral">Seguridad Laboral</option>
                                        <option value="Gerencia senior">Gerencia senior</option>
                                        <option value="Sistemas">Sistemas</option>
                                        <option value="Colaboradores">Colaboradores</option>
                                        <option value="Los Ruices">Los Ruices</option>
                                        <option value="El Rosal">El Rosal</option>
                                        <option value="La Naya">La Naya</option>
                                        <option value="TDH">TDH</option>
                                        <option value="Obras">Obras</option>
                                        <option value="Comerciales">Comerciales</option>
                                        <option value="Obras Corporativo">Obras Corporativo</option>
                                        <option value="MSO">MSO</option>
                                        <option value="El Paraiso">El Paraiso</option>
                                        <option value="Backbone">Backbone</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="usuarioAsignar">Usuario que Recibe *</label>
                                    <input type="text" id="usuarioAsignar" placeholder="Nombre del usuario" required>
                                </div>
                            </div>

                            <div class="unit-assignment">
                                <h4>Asignación por Unidades</h4>
                                <div class="unit-calc">
                                    <div>
                                        <label for="cantidadAsignarUnidades">Cantidad en Unidades *</label>
                                        <input type="number" id="cantidadAsignarUnidades" min="1" required>
                                    </div>
                                    <div>
                                        <label>Equivalencia:</label>
                                        <div class="unit-result" id="equivalenciaUnidades">0 unidades</div>
                                    </div>
                                    <div>
                                        <label>Nuevo Stock:</label>
                                        <div class="unit-result" id="nuevoStockUnidades">0 unidades</div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="fechaAsignacion">Fecha de Asignación *</label>
                                    <input type="datetime-local" id="fechaAsignacion" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group full-width">
                                    <label for="observacionesAsignacion">Observaciones</label>
                                    <textarea id="observacionesAsignacion" rows="3" placeholder="Detalles de la asignación..."></textarea>
                                </div>
                            </div>

                            <div class="form-buttons">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-check"></i> Registrar Asignación
                                </button>
                                <button type="reset" class="btn btn-secondary">
                                    <i class="fas fa-redo"></i> Limpiar
                                </button>
                            </div>
                        </form>
                    </div>
                </section>

                <!-- Sección de Movimientos -->
                <section id="movimientos" class="content-section">
                    <h2><i class="fas fa-exchange-alt"></i> Historial de Movimientos</h2>
                    <div id="movementsEmpty" style="text-align: center; padding: 40px; display: none;">
                        <i class="fas fa-exchange-alt" style="font-size: 48px; color: #ccc; margin-bottom: 20px;"></i>
                        <h3>Sin movimientos registrados</h3>
                        <p>No hay movimientos en el historial. Realice asignaciones o agregue productos para ver movimientos.</p>
                    </div>
                    <div id="movementsContent" style="display: none;">
                        <div class="filters">
                            <select id="filterMovimiento">
                                <option value="">Todos los Movimientos</option>
                                <option value="entrada">Entradas</option>
                                <option value="salida">Salidas/Asignaciones</option>
                                <option value="ajuste">Ajustes</option>
                                <option value="reposicion">Reposiciones</option>
                            </select>
                            <select id="filterMovDept" class="department-select">
                                <option value="">Todos los Departamentos</option>
                                <!-- Los departamentos se cargarán dinámicamente -->
                            </select>
                            <input type="date" id="filterMovFecha">
                            <button id="clearMovFilters"><i class="fas fa-times"></i> Limpiar filtros</button>
                        </div>
                        <div class="table-container">
                            <table id="movimientosTable">
                                <thead>
                                    <tr>
                                        <th>Fecha y Hora</th>
                                        <th>Tipo</th>
                                        <th>Producto</th>
                                        <th>Cantidad (Unidades)</th>
                                        <th>Departamento</th>
                                        <th>Usuario</th>
                                        <th>Observaciones</th>
                                        <th>Responsable</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="movimientosTableBody">
                                    <!-- Los movimientos se cargarán aquí -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Sección de Reportes -->
                <section id="reportes" class="content-section">
                    <h2><i class="fas fa-chart-bar"></i> Reportes y Estadísticas</h2>
                    <div id="reportsEmpty" style="text-align: center; padding: 40px; display: none;">
                        <i class="fas fa-chart-bar" style="font-size: 48px; color: #ccc; margin-bottom: 20px;"></i>
                        <h3>Sin datos para reportes</h3>
                        <p>No hay datos suficientes para generar reportes. Agrega productos y realiza movimientos.</p>
                    </div>
                    <div id="reportsContent" style="display: none;">
                        <div class="report-controls">
                            <select id="reportType">
                                <option value="mensual">Reporte Mensual</option>
                                <option value="anual">Reporte Anual</option>
                                <option value="departamento">Por Departamento</option>
                                <option value="productos">Por Producto</option>
                            </select>
                            <select id="reportMonth">
                                <!-- Los meses se cargarán dinámicamente -->
                            </select>
                            <select id="reportYear">
                                <!-- Los años se cargarán dinámicamente -->
                            </select>
                            <button id="generateReport" class="btn btn-primary">
                                <i class="fas fa-chart-bar"></i> Generar Reporte
                            </button>
                            <button id="exportReportExcel" class="btn btn-success">
                                <i class="fas fa-file-excel"></i> Exportar Reporte
                            </button>
                        </div>

                        <div class="reports-container">
                            <div class="report-card">
                                <h3 id="chartTitle1">Consumo por Departamento (Unidades)</h3>
                                <div class="chart-container">
                                    <canvas id="deptChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="report-card">
                                <h3 id="chartTitle2">Top 10 Productos Más Utilizados (Unidades)</h3>
                                <div class="chart-container">
                                    <canvas id="topProductsChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="report-card full-width">
                                <h3>Resumen de Movimientos</h3>
                                <div id="resumenAsignaciones">
                                    <!-- El resumen se cargará aquí -->
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Modal para editar producto -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Editar Producto</h3>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <!-- El formulario de edición se cargará aquí -->
                </div>
            </div>
        </div>

        <!-- Modal para ajustar stock -->
        <div id="adjustModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Ajustar Stock por Unidades</h3>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="adjustStockForm">
                        <div class="form-group">
                            <label for="adjustProductName">Producto</label>
                            <input type="text" id="adjustProductName" readonly>
                        </div>
                        <div class="form-group">
                            <label for="adjustCurrentStock">Stock Actual (Unidades)</label>
                            <input type="text" id="adjustCurrentStock" readonly>
                        </div>
                        <div class="form-group">
                            <label for="adjustCurrentStockMedida">Stock Actual (Medida)</label>
                            <input type="text" id="adjustCurrentStockMedida" readonly>
                        </div>
                        <div class="form-group">
                            <label for="adjustType">Tipo de Ajuste *</label>
                            <select id="adjustType" required>
                                <option value="entrada">Entrada (Agregar)</option>
                                <option value="salida">Salida (Retirar)</option>
                                <option value="reposicion">Reposición</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="adjustQuantity">Cantidad en Unidades *</label>
                            <input type="number" id="adjustQuantity" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="adjustReason">Motivo *</label>
                            <textarea id="adjustReason" rows="3" required></textarea>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="btn btn-primary">Aplicar Ajuste</button>
                            <button type="button" class="btn btn-secondary close-modal">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal de confirmación para eliminación de producto -->
        <div id="confirmModal" class="modal">
            <div class="modal-content confirm-modal">
                <div class="modal-header">
                    <h3>Confirmar Eliminación</h3>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <p>¿Está seguro de que desea eliminar este producto? Esta acción no se puede deshacer.</p>
                </div>
                <div class="modal-footer">
                    <button id="confirmDelete" class="btn btn-danger">Eliminar</button>
                    <button id="cancelDelete" class="btn btn-secondary">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Modal de confirmación para eliminación de movimiento -->
        <div id="confirmMovModal" class="modal">
            <div class="modal-content confirm-modal">
                <div class="modal-header">
                    <h3>Confirmar Eliminación de Movimiento</h3>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <p id="confirmMovMessage">¿Está seguro de que desea eliminar este movimiento? Esta acción revertirá el stock afectado.</p>
                </div>
                <div class="modal-footer">
                    <button id="confirmMovDelete" class="btn btn-danger">Eliminar</button>
                    <button id="cancelMovDelete" class="btn btn-secondary">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Modal para editar movimiento -->
        <div id="editMovModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Editar Movimiento</h3>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="editMovForm">
                        <div class="form-group">
                            <label for="editMovProducto">Producto</label>
                            <input type="text" id="editMovProducto" readonly>
                        </div>
                        <div class="form-group">
                            <label for="editMovTipo">Tipo</label>
                            <input type="text" id="editMovTipo" readonly>
                        </div>
                        <div class="form-group">
                            <label for="editMovCantidad">Cantidad (Unidades)</label>
                            <input type="text" id="editMovCantidad" readonly>
                        </div>
                        <div class="form-group" id="editMovDeptGroup">
                            <label for="editMovDepartamento">Departamento</label>
                            <input type="text" id="editMovDepartamento">
                        </div>
                        <div class="form-group">
                            <label for="editMovUsuario">Usuario</label>
                            <input type="text" id="editMovUsuario">
                        </div>
                        <div class="form-group">
                            <label for="editMovObservaciones">Observaciones</label>
                            <textarea id="editMovObservaciones" rows="3"></textarea>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                            <button type="button" class="btn btn-secondary close-modal">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal para confirmar carga de datos iniciales -->
        <div id="confirmLoadDataModal" class="modal">
            <div class="modal-content confirm-modal">
                <div class="modal-header">
                    <h3>Confirmar Carga de Datos</h3>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <p>¿Está seguro de que desea cargar los datos iniciales del inventario? Esto borrará cualquier dato existente y cargará 60 productos de ejemplo.</p>
                </div>
                <div class="modal-footer">
                    <button id="confirmLoadData" class="btn btn-primary">Cargar Datos</button>
                    <button id="cancelLoadData" class="btn btn-secondary">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Modal para confirmar limpieza de base de datos -->
        <div id="confirmClearDataModal" class="modal">
            <div class="modal-content confirm-modal">
                <div class="modal-header">
                    <h3>Confirmar Limpieza de Base de Datos</h3>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <p>¿Está seguro de que desea limpiar toda la base de datos? Esto eliminará todos los productos y movimientos. Esta acción no se puede deshacer.</p>
                </div>
                <div class="modal-footer">
                    <button id="confirmClearData" class="btn btn-danger">Limpiar Todo</button>
                    <button id="cancelClearData" class="btn btn-secondary">Cancelar</button>
                </div>
            </div>
        </div>

        <footer>
            <p>Sistema de Inventario - Artículos de Oficina &copy; 2024 | Sistema operando en modo local</p>
        </footer>
    </div>

    <script>
        // =============================================
        // CONFIGURACIÓN DE FIREBASE
        // =============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDDh9GMKi2eOVI1OeuwaBiqlEhjGpphvvk",
            authDomain: "inventario-administracion.firebaseapp.com",
            projectId: "inventario-administracion",
            storageBucket: "inventario-administracion.firebasestorage.app",
            messagingSenderId: "927319095883",
            appId: "1:927319095883:web:7c49d3294d1149990d2bce",
            databaseURL: "https://inventario-administracion-default-rtdb.firebaseio.com/"
        };

        // Variables globales
        let productos = [];
        let movimientos = [];
        let currentEditId = null;
        let currentAdjustId = null;
        let currentMovEditId = null;
        let categoryChartInstance = null;
        let deptChartInstance = null;
        let topProductsChartInstance = null;
        let firebaseInitialized = false;
        let database = null;
        let firebaseApp = null;

        // Departamentos disponibles
        const departamentos = [
            "Administración",
            "Tesorería",
            "RRHH",
            "Flota",
            "Almacén",
            "Head End",
            "Seguridad Laboral",
            "Gerencia senior",
            "Sistemas",
            "Colaboradores",
            "Los Ruices",
            "El Rosal",
            "La Naya",
            "TDH",
            "Obras",
            "Comerciales",
            "Obras Corporativo",
            "MSO",
            "El Paraiso",
            "Backbone"
        ];

        // =============================================
        // FUNCIONES BÁSICAS DEL SISTEMA
        // =============================================

        // Funciones para mostrar/ocultar loading
        function showLoading(text = "Cargando datos...") {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            if (overlay && loadingText) {
                loadingText.textContent = text;
                overlay.style.display = 'flex';
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        // Mostrar mensaje de alerta
        function showAlert(message, type = 'success') {
            const alertElement = document.createElement('div');
            alertElement.className = `alert-message alert-${type}`;
            alertElement.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i> ${message}`;
            alertElement.style.display = 'block';
            
            // Insertar después del header
            const header = document.querySelector('header');
            if (header) {
                header.appendChild(alertElement);
                
                // Auto-ocultar después de 5 segundos
                setTimeout(() => {
                    alertElement.remove();
                }, 5000);
            }
        }

        // Actualizar estado de conexión
        function updateConnectionStatus(connected, message = null) {
            const statusElement = document.getElementById('connectionStatus');
            const firebaseStatusElement = document.getElementById('firebaseStatus');
            
            if (statusElement) {
                const icon = statusElement.querySelector('i');
                const text = statusElement.querySelector('span');
                
                if (connected) {
                    icon.style.color = '#27ae60';
                    text.textContent = message || 'Conectado a Firebase';
                    if (firebaseStatusElement) firebaseStatusElement.textContent = 'Conectado';
                } else {
                    icon.style.color = '#e74c3c';
                    text.textContent = message || 'Sin conexión';
                    if (firebaseStatusElement) firebaseStatusElement.textContent = message || 'Desconectado';
                }
            }
        }

        // Cerrar todos los modales
        function cerrarModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }

        // Mostrar sección específica
        function mostrarSeccion(sectionId) {
            // Ocultar todas las secciones
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Mostrar la sección seleccionada
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }
        }

        // Actualizar fecha y hora
        function actualizarFechaHora() {
            const now = new Date();
            const dateTimeStr = now.toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            const dateTimeElement = document.getElementById('currentDateTime');
            if (dateTimeElement) {
                dateTimeElement.textContent = dateTimeStr;
            }
        }

        // Funciones para calcular unidades
        function calcularUnidadesTotales(producto) {
            return producto.stock * (producto.unidadesPorMedida || 1);
        }

        function calcularStockDesdeUnidades(producto, unidadesTotales) {
            if (!producto.unidadesPorMedida || producto.unidadesPorMedida === 0) {
                return unidadesTotales;
            }
            return unidadesTotales / producto.unidadesPorMedida;
        }

        function formatearFechaHora(fechaHoraStr = null) {
            const ahora = fechaHoraStr ? new Date(fechaHoraStr) : new Date();
            const fecha = ahora.toISOString().split('T')[0];
            const hora = ahora.toTimeString().split(' ')[0].substring(0, 8);
            return `${fecha} ${hora}`;
        }

        // =============================================
        // FUNCIONES FIREBASE - CORREGIDAS
        // =============================================

        // Inicializar Firebase con manejo de errores mejorado
        async function initializeFirebase() {
            showLoading('Conectando con Firebase...');
            
            try {
                // Verificar si Firebase SDK está cargado
                if (typeof firebase === 'undefined' || typeof firebase.initializeApp === 'undefined') {
                    throw new Error('Firebase SDK no está cargado correctamente');
                }

                // Verificar si Firebase ya está inicializado
                if (firebase.apps && firebase.apps.length > 0) {
                    firebaseApp = firebase.apps[0];
                    console.log('Firebase ya está inicializado');
                } else {
                    // Inicializar Firebase
                    firebaseApp = firebase.initializeApp(firebaseConfig);
                    console.log('Firebase inicializado correctamente');
                }
                
                // Inicializar Database
                database = firebase.database();
                firebaseInitialized = true;
                
                // Verificar conexión
                const connectedRef = database.ref(".info/connected");
                connectedRef.on("value", function(snap) {
                    if (snap.val() === true) {
                        console.log("Conectado a Firebase Realtime Database");
                        updateConnectionStatus(true, 'Conectado a Firebase');
                    } else {
                        console.log("Desconectado de Firebase Realtime Database");
                        updateConnectionStatus(false, 'Desconectado de Firebase');
                    }
                });
                
                hideLoading();
                return true;
            } catch (error) {
                console.error('Error al inicializar Firebase:', error);
                hideLoading();
                updateConnectionStatus(false, 'Error de conexión');
                document.getElementById('firebaseAlert').style.display = 'block';
                
                // Mostrar mensaje detallado
                let errorMessage = 'Error de conexión con Firebase: ';
                if (error.code) {
                    errorMessage += `Código: ${error.code}`;
                } else if (error.message) {
                    errorMessage += error.message;
                }
                
                showAlert(errorMessage, 'error');
                return false;
            }
        }

        // Cargar datos desde Firebase o localStorage
        async function loadData() {
            showLoading('Cargando datos del inventario...');
            
            try {
                if (firebaseInitialized && database) {
                    console.log('Intentando cargar datos desde Firebase...');
                    
                    // Intentar cargar desde Firebase con timeout
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout al conectar con Firebase')), 10000)
                    );
                    
                    const productosPromise = database.ref('productos').once('value');
                    const movimientosPromise = database.ref('movimientos').once('value');
                    
                    // Usar Promise.race para timeout
                    const productosSnapshot = await Promise.race([productosPromise, timeoutPromise]);
                    const movimientosSnapshot = await Promise.race([movimientosPromise, timeoutPromise]);
                    
                    const productosData = productosSnapshot.val();
                    const movimientosData = movimientosSnapshot.val();
                    
                    if (productosData) {
                        productos = Object.values(productosData);
                        const keys = Object.keys(productosData);
                        productos.forEach((producto, index) => {
                            producto.firebaseKey = keys[index];
                        });
                        console.log('Productos cargados desde Firebase:', productos.length);
                    }
                    
                    if (movimientosData) {
                        movimientos = Object.values(movimientosData);
                        const keys = Object.keys(movimientosData);
                        movimientos.forEach((movimiento, index) => {
                            movimiento.firebaseKey = keys[index];
                        });
                        console.log('Movimientos cargados desde Firebase:', movimientos.length);
                    }
                    
                    // Guardar copia en localStorage como backup
                    localStorage.setItem('inventarioProductos', JSON.stringify(productos));
                    localStorage.setItem('inventarioMovimientos', JSON.stringify(movimientos));
                    
                    console.log('Datos cargados exitosamente desde Firebase');
                    
                } else {
                    // Cargar desde localStorage como fallback
                    console.log('Cargando datos desde localStorage (modo offline)...');
                    const productosLocal = localStorage.getItem('inventarioProductos');
                    const movimientosLocal = localStorage.getItem('inventarioMovimientos');
                    
                    if (productosLocal) {
                        productos = JSON.parse(productosLocal);
                        console.log('Productos cargados desde localStorage:', productos.length);
                    }
                    
                    if (movimientosLocal) {
                        movimientos = JSON.parse(movimientosLocal);
                        console.log('Movimientos cargados desde localStorage:', movimientos.length);
                    }
                }
                
                // Actualizar interfaz
                actualizarInterfaz();
                hideLoading();
                
                return true;
            } catch (error) {
                console.error('Error al cargar datos:', error);
                hideLoading();
                
                // Intentar cargar desde localStorage si Firebase falla
                try {
                    console.log('Falló Firebase, cargando desde localStorage...');
                    const productosLocal = localStorage.getItem('inventarioProductos');
                    const movimientosLocal = localStorage.getItem('inventarioMovimientos');
                    
                    if (productosLocal) {
                        productos = JSON.parse(productosLocal);
                    }
                    
                    if (movimientosLocal) {
                        movimientos = JSON.parse(movimientosLocal);
                    }
                    
                    showAlert('Usando datos locales (modo offline)', 'error');
                    actualizarInterfaz();
                    return true;
                } catch (localError) {
                    console.error('Error al cargar datos locales:', localError);
                    showAlert('Error al cargar datos. El inventario está vacío.', 'error');
                    actualizarInterfaz();
                    return false;
                }
            }
        }

        // Guardar datos en Firebase y localStorage
        async function saveData() {
            try {
                if (firebaseInitialized && database) {
                    console.log('Guardando datos en Firebase...');
                    
                    // Guardar productos
                    const productosObj = {};
                    productos.forEach(producto => {
                        if (producto.firebaseKey) {
                            productosObj[producto.firebaseKey] = producto;
                        } else {
                            const newKey = database.ref('productos').push().key;
                            producto.firebaseKey = newKey;
                            productosObj[newKey] = producto;
                        }
                    });
                    await database.ref('productos').set(productosObj);
                    
                    // Guardar movimientos
                    const movimientosObj = {};
                    movimientos.forEach(movimiento => {
                        if (movimiento.firebaseKey) {
                            movimientosObj[movimiento.firebaseKey] = movimiento;
                        } else {
                            const newKey = database.ref('movimientos').push().key;
                            movimiento.firebaseKey = newKey;
                            movimientosObj[newKey] = movimiento;
                        }
                    });
                    await database.ref('movimientos').set(movimientosObj);
                    
                    console.log('Datos guardados exitosamente en Firebase');
                } else {
                    console.log('Firebase no disponible, guardando solo en localStorage');
                }
                
                // Siempre guardar en localStorage como backup
                localStorage.setItem('inventarioProductos', JSON.stringify(productos));
                localStorage.setItem('inventarioMovimientos', JSON.stringify(movimientos));
                
                return true;
            } catch (error) {
                console.error('Error al guardar datos en Firebase:', error);
                
                // Si Firebase falla, guardar solo en localStorage
                try {
                    localStorage.setItem('inventarioProductos', JSON.stringify(productos));
                    localStorage.setItem('inventarioMovimientos', JSON.stringify(movimientos));
                    console.log('Datos guardados en localStorage (modo offline)');
                    
                    // Mostrar advertencia
                    if (firebaseInitialized) {
                        showAlert('Error al guardar en Firebase. Datos guardados localmente.', 'error');
                    }
                    return true;
                } catch (localError) {
                    console.error('Error al guardar en localStorage:', localError);
                    showAlert('Error al guardar datos', 'error');
                    return false;
                }
            }
        }

        // =============================================
        // FUNCIONES DEL SISTEMA DE INVENTARIO
        // =============================================

        // Actualizar toda la interfaz basado en datos
        function actualizarInterfaz() {
            console.log('Actualizando interfaz con', productos.length, 'productos y', movimientos.length, 'movimientos');
            
            // Mostrar/ocultar contenido vacío
            const hasData = productos.length > 0;
            
            const dashboardEmpty = document.getElementById('dashboardEmpty');
            const dashboardContent = document.getElementById('dashboardContent');
            const inventoryEmpty = document.getElementById('inventoryEmpty');
            const inventoryContent = document.getElementById('inventoryContent');
            const assignEmpty = document.getElementById('assignEmpty');
            const assignContent = document.getElementById('assignContent');
            const movementsEmpty = document.getElementById('movementsEmpty');
            const movementsContent = document.getElementById('movementsContent');
            const reportsEmpty = document.getElementById('reportsEmpty');
            const reportsContent = document.getElementById('reportsContent');
            
            if (dashboardEmpty) dashboardEmpty.style.display = hasData ? 'none' : 'block';
            if (dashboardContent) dashboardContent.style.display = hasData ? 'block' : 'none';
            if (inventoryEmpty) inventoryEmpty.style.display = hasData ? 'none' : 'block';
            if (inventoryContent) inventoryContent.style.display = hasData ? 'block' : 'none';
            if (assignEmpty) assignEmpty.style.display = hasData ? 'none' : 'block';
            if (assignContent) assignContent.style.display = hasData ? 'block' : 'none';
            if (movementsEmpty) movementsEmpty.style.display = movimientos.length > 0 ? 'none' : 'block';
            if (movementsContent) movementsContent.style.display = movimientos.length > 0 ? 'block' : 'none';
            if (reportsEmpty) reportsEmpty.style.display = hasData ? 'none' : 'block';
            if (reportsContent) reportsContent.style.display = hasData ? 'block' : 'none';
            
            // Actualizar componentes específicos
            if (hasData) {
                actualizarTablaInventario();
                cargarProductosAsignacion();
                actualizarEstadisticas();
                actualizarDashboard();
                verificarStockBajo();
                
                // Generar reporte inicial si hay datos
                generarReporteMensual();
            } else {
                // Limpiar tablas
                const inventarioTableBody = document.getElementById('inventarioTableBody');
                const movimientosTableBody = document.getElementById('movimientosTableBody');
                
                if (inventarioTableBody) inventarioTableBody.innerHTML = '';
                if (movimientosTableBody) movimientosTableBody.innerHTML = '';
                
                // Actualizar contadores
                const totalProducts = document.getElementById('totalProducts');
                const lowStockCount = document.getElementById('lowStockCount');
                const todayAssignments = document.getElementById('todayAssignments');
                const totalStock = document.getElementById('totalStock');
                
                if (totalProducts) totalProducts.textContent = '0';
                if (lowStockCount) lowStockCount.textContent = '0';
                if (todayAssignments) todayAssignments.textContent = '0';
                if (totalStock) totalStock.textContent = '0';
                
                // Actualizar dashboard
                const dashboardTotalProducts = document.getElementById('dashboardTotalProducts');
                const dashboardLowStock = document.getElementById('dashboardLowStock');
                const dashboardTotalAssignments = document.getElementById('dashboardTotalAssignments');
                const dashboardTotalUnits = document.getElementById('dashboardTotalUnits');
                
                if (dashboardTotalProducts) dashboardTotalProducts.textContent = '0';
                if (dashboardLowStock) dashboardLowStock.textContent = '0';
                if (dashboardTotalAssignments) dashboardTotalAssignments.textContent = '0';
                if (dashboardTotalUnits) dashboardTotalUnits.textContent = '0';
            }
        }

        // Configurar eventos básicos (sin depender de Firebase)
        function configurarEventosBasicos() {
            // Navegación del menú
            document.querySelectorAll('.menu-btn[data-section]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    mostrarSeccion(section);
                    
                    // Actualizar clase activa
                    document.querySelectorAll('.menu-btn[data-section]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Cerrar modales
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', cerrarModal);
            });
            
            // Cerrar modal al hacer clic fuera
            window.addEventListener('click', function(event) {
                const modals = [
                    'editModal', 'confirmModal', 'adjustModal', 'editMovModal', 'confirmMovModal',
                    'confirmLoadDataModal', 'confirmClearDataModal'
                ];
                
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (event.target === modal) {
                        cerrarModal();
                    }
                });
            });
        }

        // Configurar eventos completos
        function configurarEventos() {
            // Formulario de nuevo producto
            const nuevoProductoForm = document.getElementById('nuevoProductoForm');
            if (nuevoProductoForm) {
                nuevoProductoForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    guardarProducto();
                });
            }
            
            // Botón de reposición
            const repositionBtn = document.getElementById('repositionBtn');
            if (repositionBtn) {
                repositionBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    guardarReposicion();
                });
            }
            
            // Select de producto en asignación
            const productoAsignar = document.getElementById('productoAsignar');
            if (productoAsignar) {
                productoAsignar.addEventListener('change', function() {
                    const productoId = this.value;
                    if (productoId) {
                        const producto = productos.find(p => p.firebaseKey === productoId);
                        if (producto) {
                            const unidadesTotales = calcularUnidadesTotales(producto);
                            const stockDisponible = document.getElementById('stockDisponible');
                            if (stockDisponible) stockDisponible.value = `${unidadesTotales} unidades`;
                            calcularEquivalenciaAsignacion();
                        }
                    } else {
                        const stockDisponible = document.getElementById('stockDisponible');
                        const equivalenciaUnidades = document.getElementById('equivalenciaUnidades');
                        const nuevoStockUnidades = document.getElementById('nuevoStockUnidades');
                        
                        if (stockDisponible) stockDisponible.value = '';
                        if (equivalenciaUnidades) equivalenciaUnidades.textContent = '0 unidades';
                        if (nuevoStockUnidades) nuevoStockUnidades.textContent = '0 unidades';
                    }
                });
            }
            
            // Botón limpiar filtros inventario
            const clearFilters = document.getElementById('clearFilters');
            if (clearFilters) {
                clearFilters.addEventListener('click', limpiarFiltrosInventario);
            }
            
            // Botón limpiar filtros movimientos
            const clearMovFilters = document.getElementById('clearMovFilters');
            if (clearMovFilters) {
                clearMovFilters.addEventListener('click', limpiarFiltrosMovimientos);
            }
            
            // Filtros de búsqueda inventario
            const searchProduct = document.getElementById('searchProduct');
            if (searchProduct) {
                searchProduct.addEventListener('input', actualizarTablaInventario);
            }
            
            const filterCategory = document.getElementById('filterCategory');
            if (filterCategory) {
                filterCategory.addEventListener('change', actualizarTablaInventario);
            }
            
            const filterStock = document.getElementById('filterStock');
            if (filterStock) {
                filterStock.addEventListener('change', actualizarTablaInventario);
            }
            
            // Filtros de movimientos
            const filterMovimiento = document.getElementById('filterMovimiento');
            if (filterMovimiento) {
                filterMovimiento.addEventListener('change', actualizarTablaMovimientos);
            }
            
            const filterMovDept = document.getElementById('filterMovDept');
            if (filterMovDept) {
                filterMovDept.addEventListener('change', actualizarTablaMovimientos);
            }
            
            const filterMovFecha = document.getElementById('filterMovFecha');
            if (filterMovFecha) {
                filterMovFecha.addEventListener('change', actualizarTablaMovimientos);
            }
            
            // Tipo de reporte
            const reportType = document.getElementById('reportType');
            if (reportType) {
                reportType.addEventListener('change', function() {
                    const monthSelect = document.getElementById('reportMonth');
                    if (monthSelect) {
                        if (this.value === 'departamento' || this.value === 'productos') {
                            monthSelect.style.display = 'none';
                        } else {
                            monthSelect.style.display = 'block';
                        }
                    }
                });
            }
            
            // Generar reporte
            const generateReport = document.getElementById('generateReport');
            if (generateReport) {
                generateReport.addEventListener('click', function() {
                    const reportType = document.getElementById('reportType');
                    if (!reportType) return;
                    
                    const reportTypeValue = reportType.value;
                    if (reportTypeValue === 'mensual') {
                        generarReporteMensual();
                    } else if (reportTypeValue === 'anual') {
                        generarReporteAnual();
                    } else if (reportTypeValue === 'departamento') {
                        generarReporteDepartamento();
                    } else {
                        generarReporteProductos();
                    }
                });
            }
            
            // Exportar reporte Excel
            const exportReportExcel = document.getElementById('exportReportExcel');
            if (exportReportExcel) {
                exportReportExcel.addEventListener('click', exportarReporteExcel);
            }
            
            // Botones de exportación
            const exportPdf = document.getElementById('exportPdf');
            if (exportPdf) {
                exportPdf.addEventListener('click', exportarPDF);
            }
            
            const exportExcel = document.getElementById('exportExcel');
            if (exportExcel) {
                exportExcel.addEventListener('click', exportarExcel);
            }
            
            const exportInventoryExcel = document.getElementById('exportInventoryExcel');
            if (exportInventoryExcel) {
                exportInventoryExcel.addEventListener('click', exportarInventarioActualExcel);
            }
            
            // Botón cargar datos iniciales
            const loadInitialData = document.getElementById('loadInitialData');
            if (loadInitialData) {
                loadInitialData.addEventListener('click', function() {
                    const modal = document.getElementById('confirmLoadDataModal');
                    if (modal) modal.style.display = 'flex';
                });
            }
            
            // Botón limpiar base de datos
            const clearAllData = document.getElementById('clearAllData');
            if (clearAllData) {
                clearAllData.addEventListener('click', function() {
                    const modal = document.getElementById('confirmClearDataModal');
                    if (modal) modal.style.display = 'flex';
                });
            }
            
            // Confirmar carga de datos
            const confirmLoadData = document.getElementById('confirmLoadData');
            if (confirmLoadData) {
                confirmLoadData.addEventListener('click', async function() {
                    const modal = document.getElementById('confirmLoadDataModal');
                    if (modal) modal.style.display = 'none';
                    await loadInitialData();
                });
            }
            
            const cancelLoadData = document.getElementById('cancelLoadData');
            if (cancelLoadData) {
                cancelLoadData.addEventListener('click', function() {
                    const modal = document.getElementById('confirmLoadDataModal');
                    if (modal) modal.style.display = 'none';
                });
            }
            
            // Confirmar limpieza de datos
            const confirmClearData = document.getElementById('confirmClearData');
            if (confirmClearData) {
                confirmClearData.addEventListener('click', async function() {
                    const modal = document.getElementById('confirmClearDataModal');
                    if (modal) modal.style.display = 'none';
                    await clearAllData();
                });
            }
            
            const cancelClearData = document.getElementById('cancelClearData');
            if (cancelClearData) {
                cancelClearData.addEventListener('click', function() {
                    const modal = document.getElementById('confirmClearDataModal');
                    if (modal) modal.style.display = 'none';
                });
            }
            
            // Confirmar eliminación de producto
            const confirmDelete = document.getElementById('confirmDelete');
            if (confirmDelete) {
                confirmDelete.addEventListener('click', eliminarProducto);
            }
            
            const cancelDelete = document.getElementById('cancelDelete');
            if (cancelDelete) {
                cancelDelete.addEventListener('click', cerrarModal);
            }
            
            // Confirmar eliminación de movimiento
            const confirmMovDelete = document.getElementById('confirmMovDelete');
            if (confirmMovDelete) {
                confirmMovDelete.addEventListener('click', eliminarMovimiento);
            }
            
            const cancelMovDelete = document.getElementById('cancelMovDelete');
            if (cancelMovDelete) {
                cancelMovDelete.addEventListener('click', cerrarModal);
            }
            
            // Formulario de edición de movimiento
            const editMovForm = document.getElementById('editMovForm');
            if (editMovForm) {
                editMovForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    guardarCambiosMovimiento();
                });
            }
            
            // Configurar evento para cálculo de equivalencia en asignación
            const cantidadInput = document.getElementById('cantidadAsignarUnidades');
            if (cantidadInput) {
                cantidadInput.addEventListener('input', calcularEquivalenciaAsignacion);
            }
            
            // Configurar evento para verificar código existente
            const codigoInput = document.getElementById('codigoProducto');
            if (codigoInput) {
                codigoInput.addEventListener('blur', verificarCodigoExistente);
            }
        }

        // =============================================
        // FUNCIONES DEL INVENTARIO (SIMPLIFICADAS)
        // =============================================

        // Función simplificada para actualizar tabla de inventario
        function actualizarTablaInventario() {
            const inventarioTableBody = document.getElementById('inventarioTableBody');
            if (!inventarioTableBody) return;
            
            inventarioTableBody.innerHTML = '';
            
            // Aplicar filtros
            let productosFiltrados = [...productos];
            
            // Filtrar por búsqueda
            const searchTerm = document.getElementById('searchProduct')?.value.toLowerCase() || '';
            if (searchTerm) {
                productosFiltrados = productosFiltrados.filter(p => 
                    p.nombre.toLowerCase().includes(searchTerm) || 
                    p.codigo.toLowerCase().includes(searchTerm)
                );
            }
            
            // Filtrar por categoría
            const filterCategory = document.getElementById('filterCategory')?.value || '';
            if (filterCategory) {
                productosFiltrados = productosFiltrados.filter(p => p.categoria === filterCategory);
            }
            
            // Filtrar por stock
            const filterStock = document.getElementById('filterStock')?.value || '';
            if (filterStock === 'low') {
                productosFiltrados = productosFiltrados.filter(p => p.stock <= p.stockMinimo);
            }
            
            // Mostrar productos
            productosFiltrados.forEach((producto, index) => {
                const unidadesTotales = calcularUnidadesTotales(producto);
                const stockEstado = producto.stock <= producto.stockMinimo ? 'Bajo' : 
                                  producto.stock > producto.stockMinimo * 2 ? 'Alto' : 'Normal';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>
                        <strong>${producto.nombre}</strong><br>
                        <small>Código: ${producto.codigo}</small>
                    </td>
                    <td>
                        <span class="badge badge-${producto.categoria}">
                            ${producto.categoria}
                        </span>
                    </td>
                    <td class="stock-details">
                        <span class="stock-total">${producto.stock} ${producto.unidad}</span>
                        <span class="unit-info">${unidadesTotales} unidades totales</span>
                    </td>
                    <td>${unidadesTotales}</td>
                    <td>
                        ${producto.unidad}
                        ${producto.unidadesPorMedida > 1 ? 
                            `<span class="unit-badge">x${producto.unidadesPorMedida}</span>` : ''}
                    </td>
                    <td>${producto.stockMinimo} ${producto.unidad}</td>
                    <td>
                        <span class="stock-indicator stock-${stockEstado.toLowerCase()}"></span>
                        ${stockEstado}
                    </td>
                    <td class="action-buttons">
                        <button class="btn-action btn-edit" onclick="editarProducto('${producto.firebaseKey}')">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn-action btn-delete" onclick="confirmarEliminarProducto('${producto.firebaseKey}')">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                        <button class="btn-action btn-assign" onclick="ajustarStock('${producto.firebaseKey}')">
                            <i class="fas fa-exchange-alt"></i> Ajustar
                        </button>
                    </td>
                `;
                inventarioTableBody.appendChild(row);
            });
            
            // Actualizar contador
            const totalProducts = document.getElementById('totalProducts');
            if (totalProducts) {
                totalProducts.textContent = productosFiltrados.length;
            }
        }

        // Función simplificada para cargar productos en asignación
        function cargarProductosAsignacion() {
            const productoAsignar = document.getElementById('productoAsignar');
            if (!productoAsignar) return;
            
            productoAsignar.innerHTML = '<option value="">Seleccione...</option>';
            
            productos.forEach(producto => {
                const unidadesTotales = calcularUnidadesTotales(producto);
                if (unidadesTotales > 0) {
                    const option = document.createElement('option');
                    option.value = producto.firebaseKey;
                    option.textContent = `${producto.nombre} (${unidadesTotales} unidades disponibles)`;
                    productoAsignar.appendChild(option);
                }
            });
        }

        // Función simplificada para actualizar estadísticas
        function actualizarEstadisticas() {
            // Contar productos con stock bajo
            const productosBajos = productos.filter(p => p.stock <= p.stockMinimo);
            const lowStockCount = document.getElementById('lowStockCount');
            if (lowStockCount) lowStockCount.textContent = productosBajos.length;
            
            // Calcular asignaciones de hoy
            const hoy = new Date().toISOString().split('T')[0];
            const asignacionesHoy = movimientos.filter(m => 
                m.tipo === 'salida' && m.fecha && m.fecha.includes(hoy)
            );
            const todayAssignments = document.getElementById('todayAssignments');
            if (todayAssignments) todayAssignments.textContent = asignacionesHoy.length;
            
            // Calcular stock total en unidades
            let totalUnidades = 0;
            productos.forEach(p => {
                totalUnidades += calcularUnidadesTotales(p);
            });
            const totalStock = document.getElementById('totalStock');
            if (totalStock) totalStock.textContent = totalUnidades;
            
            // Actualizar alerta de stock bajo
            const stockAlert = document.getElementById('stockAlert');
            if (stockAlert) {
                if (productosBajos.length > 0) {
                    stockAlert.classList.add('show');
                    const alertMessage = document.getElementById('alertMessage');
                    if (alertMessage) {
                        alertMessage.textContent = `Hay ${productosBajos.length} productos con stock bajo. Verifique el inventario.`;
                    }
                } else {
                    stockAlert.classList.remove('show');
                }
            }
        }

        // Función simplificada para actualizar dashboard
        function actualizarDashboard() {
            // Productos totales
            const dashboardTotalProducts = document.getElementById('dashboardTotalProducts');
            if (dashboardTotalProducts) dashboardTotalProducts.textContent = productos.length;
            
            // Productos con stock bajo
            const productosBajos = productos.filter(p => p.stock <= p.stockMinimo);
            const dashboardLowStock = document.getElementById('dashboardLowStock');
            if (dashboardLowStock) dashboardLowStock.textContent = productosBajos.length;
            
            // Asignaciones este mes
            const mesActual = new Date().getMonth();
            const asignacionesMes = movimientos.filter(m => 
                m.tipo === 'salida' && new Date(m.fecha).getMonth() === mesActual
            );
            const dashboardTotalAssignments = document.getElementById('dashboardTotalAssignments');
            if (dashboardTotalAssignments) dashboardTotalAssignments.textContent = asignacionesMes.length;
            
            // Total unidades disponibles
            let totalUnidades = 0;
            productos.forEach(p => {
                totalUnidades += calcularUnidadesTotales(p);
            });
            const dashboardTotalUnits = document.getElementById('dashboardTotalUnits');
            if (dashboardTotalUnits) dashboardTotalUnits.textContent = totalUnidades;
            
            // Actualizar lista de productos con stock bajo
            const lowStockList = document.getElementById('lowStockList');
            if (lowStockList) {
                if (productosBajos.length > 0) {
                    let html = '';
                    productosBajos.forEach(producto => {
                        const unidadesTotales = calcularUnidadesTotales(producto);
                        html += `
                            <div class="product-card low-stock">
                                <div class="product-card-header">
                                    <div class="product-name">${producto.nombre}</div>
                                    <div class="product-category">${producto.categoria}</div>
                                </div>
                                <div class="product-stock">
                                    Stock actual: ${producto.stock} ${producto.unidad} (${unidadesTotales} unidades)<br>
                                    Stock mínimo: ${producto.stockMinimo} ${producto.unidad}
                                </div>
                                <div class="stock-progress">
                                    <div class="stock-progress-bar low" style="width: ${(producto.stock / producto.stockMinimo * 100).toFixed(0)}%"></div>
                                </div>
                            </div>
                        `;
                    });
                    lowStockList.innerHTML = html;
                } else {
                    lowStockList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay productos con stock bajo</p>';
                }
            }
            
            // Actualizar gráfico de categorías
            actualizarGraficoCategorias();
        }

        // Función simplificada para verificar stock bajo
        function verificarStockBajo() {
            const productosBajos = productos.filter(p => p.stock <= p.stockMinimo);
            const stockAlert = document.getElementById('stockAlert');
            if (stockAlert) {
                if (productosBajos.length > 0) {
                    stockAlert.classList.add('show');
                    const alertMessage = document.getElementById('alertMessage');
                    if (alertMessage) {
                        alertMessage.textContent = `Hay ${productosBajos.length} productos con stock bajo. Verifique el inventario.`;
                    }
                } else {
                    stockAlert.classList.remove('show');
                }
            }
        }

        // Función simplificada para actualizar gráfico de categorías
        function actualizarGraficoCategorias() {
            const ctx = document.getElementById('categoryChart');
            if (!ctx) return;
            
            // Destruir gráfico anterior si existe
            if (categoryChartInstance) {
                categoryChartInstance.destroy();
            }
            
            // Agrupar por categoría
            const categorias = {};
            productos.forEach(p => {
                if (!categorias[p.categoria]) {
                    categorias[p.categoria] = 0;
                }
                categorias[p.categoria] += calcularUnidadesTotales(p);
            });
            
            const labels = Object.keys(categorias);
            const data = Object.values(categorias);
            
            // Colores para las categorías
            const backgroundColors = [
                '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c'
            ];
            
            categoryChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors.slice(0, labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // =============================================
        // INICIALIZACIÓN DEL SISTEMA
        // =============================================

        // Inicialización cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('Inicializando sistema de inventario...');
                showLoading('Inicializando sistema...');
                
                // 1. Configurar eventos básicos primero
                configurarEventosBasicos();
                
                // 2. Inicializar fecha/hora
                actualizarFechaHora();
                setInterval(actualizarFechaHora, 1000);
                
                // 3. Configurar fecha y hora actual por defecto
                const fechaInput = document.getElementById('fechaAsignacion');
                if (fechaInput) {
                    const ahora = new Date();
                    ahora.setMinutes(ahora.getMinutes() - ahora.getTimezoneOffset());
                    fechaInput.value = ahora.toISOString().slice(0, 16);
                }
                
                // 4. Generar meses y años para reportes
                // (función simplificada)
                generarOpcionesFechaReporte();
                
                // 5. Intentar inicializar Firebase
                console.log('Inicializando Firebase...');
                const firebaseSuccess = await initializeFirebase();
                
                if (firebaseSuccess) {
                    console.log('Firebase inicializado, cargando datos...');
                    // 6. Cargar datos desde Firebase
                    await loadData();
                } else {
                    console.log('Firebase falló, usando datos locales...');
                    // Intentar cargar datos locales
                    await loadData();
                }
                
                // 7. Configurar todos los eventos
                configurarEventos();
                
                // 8. Actualizar interfaz final
                actualizarInterfaz();
                
                hideLoading();
                console.log('Sistema inicializado correctamente');
                
            } catch (error) {
                console.error('Error crítico al inicializar el sistema:', error);
                hideLoading();
                showAlert('Error crítico al inicializar el sistema: ' + error.message, 'error');
                updateConnectionStatus(false, 'Error de inicialización');
            }
        });

        // =============================================
        // FUNCIONES SIMPLIFICADAS (PARA COMPLETAR)
        // =============================================

        // Estas funciones necesitan ser implementadas completamente

        function generarOpcionesFechaReporte() {
            // Implementación simplificada
            const reportMonth = document.getElementById('reportMonth');
            const reportYear = document.getElementById('reportYear');
            
            if (reportMonth) {
                reportMonth.innerHTML = '<option value="">Seleccione mes</option>';
                const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                meses.forEach((mes, index) => {
                    const option = document.createElement('option');
                    option.value = index + 1;
                    option.textContent = mes;
                    reportMonth.appendChild(option);
                });
            }
            
            if (reportYear) {
                reportYear.innerHTML = '<option value="">Seleccione año</option>';
                const añoActual = new Date().getFullYear();
                for (let i = añoActual; i >= añoActual - 5; i--) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    reportYear.appendChild(option);
                }
            }
        }

        function generarReporteMensual() {
            showAlert('Función generarReporteMensual() necesita implementación completa', 'error');
        }

        function generarReporteAnual() {
            showAlert('Función generarReporteAnual() necesita implementación completa', 'error');
        }

        function generarReporteDepartamento() {
            showAlert('Función generarReporteDepartamento() necesita implementación completa', 'error');
        }

        function generarReporteProductos() {
            showAlert('Función generarReporteProductos() necesita implementación completa', 'error');
        }

        function exportarReporteExcel() {
            showAlert('Función exportarReporteExcel() necesita implementación completa', 'error');
        }

        function exportarPDF() {
            showAlert('Función exportarPDF() necesita implementación completa', 'error');
        }

        function exportarExcel() {
            showAlert('Función exportarExcel() necesita implementación completa', 'error');
        }

        function exportarInventarioActualExcel() {
            showAlert('Función exportarInventarioActualExcel() necesita implementación completa', 'error');
        }

        function calcularEquivalenciaAsignacion() {
            const productoId = document.getElementById('productoAsignar')?.value;
            const cantidadUnidades = document.getElementById('cantidadAsignarUnidades')?.value || 0;
            
            if (!productoId || !cantidadUnidades) return;
            
            const producto = productos.find(p => p.firebaseKey === productoId);
            if (!producto) return;
            
            const unidadesPorMedida = producto.unidadesPorMedida || 1;
            const equivalencia = cantidadUnidades / unidadesPorMedida;
            
            const equivalenciaUnidades = document.getElementById('equivalenciaUnidades');
            if (equivalenciaUnidades) {
                equivalenciaUnidades.textContent = `${equivalencia.toFixed(2)} ${producto.unidad}`;
            }
            
            const stockActual = calcularUnidadesTotales(producto);
            const nuevoStock = stockActual - cantidadUnidades;
            
            const nuevoStockUnidades = document.getElementById('nuevoStockUnidades');
            if (nuevoStockUnidades) {
                nuevoStockUnidades.textContent = `${nuevoStock} unidades`;
            }
        }

        function verificarCodigoExistente() {
            const codigo = document.getElementById('codigoProducto')?.value;
            if (!codigo) return;
            
            const productoExistente = productos.find(p => p.codigo === codigo);
            const repositionBtn = document.getElementById('repositionBtn');
            const saveProductBtn = document.getElementById('saveProductBtn');
            
            if (productoExistente) {
                // Mostrar botón de reposición
                if (repositionBtn) repositionBtn.style.display = 'block';
                if (saveProductBtn) saveProductBtn.style.display = 'none';
                showAlert(`Producto encontrado: ${productoExistente.nombre}. Puede reponer stock.`, 'success');
            } else {
                // Mostrar botón de guardar nuevo producto
                if (repositionBtn) repositionBtn.style.display = 'none';
                if (saveProductBtn) saveProductBtn.style.display = 'block';
            }
        }

        async function guardarProducto() {
            try {
                const codigo = document.getElementById('codigoProducto')?.value;
                const nombre = document.getElementById('nombreProducto')?.value;
                const categoria = document.getElementById('categoriaProducto')?.value;
                const unidad = document.getElementById('unidadProducto')?.value;
                const unidadesPorMedida = parseInt(document.getElementById('unidadesPorMedida')?.value) || 1;
                const stock = parseInt(document.getElementById('stockInicial')?.value) || 0;
                const stockMinimo = parseInt(document.getElementById('stockMinimo')?.value) || 5;
                const descripcion = document.getElementById('descripcionProducto')?.value;
                
                // Validaciones básicas
                if (!codigo || !nombre || !categoria || !unidad) {
                    showAlert('Por favor complete todos los campos obligatorios', 'error');
                    return;
                }
                
                // Verificar si el código ya existe
                const productoExistente = productos.find(p => p.codigo === codigo);
                if (productoExistente) {
                    showAlert('El código del producto ya existe. Use otro código o reponga stock.', 'error');
                    return;
                }
                
                const nuevoProducto = {
                    codigo,
                    nombre,
                    categoria,
                    unidad,
                    unidadesPorMedida,
                    stock,
                    stockMinimo,
                    descripcion: descripcion || '',
                    fechaRegistro: new Date().toISOString().split('T')[0]
                };
                
                productos.push(nuevoProducto);
                await saveData();
                actualizarInterfaz();
                showAlert('Producto guardado correctamente', 'success');
                
                // Limpiar formulario
                document.getElementById('nuevoProductoForm')?.reset();
                
            } catch (error) {
                console.error('Error al guardar producto:', error);
                showAlert('Error al guardar producto', 'error');
            }
        }

        async function guardarReposicion() {
            try {
                const codigo = document.getElementById('codigoProducto')?.value;
                const cantidad = parseInt(document.getElementById('stockInicial')?.value) || 0;
                const descripcion = document.getElementById('descripcionProducto')?.value;
                
                if (!codigo || cantidad <= 0) {
                    showAlert('Por favor ingrese un código válido y cantidad mayor a 0', 'error');
                    return;
                }
                
                const productoIndex = productos.findIndex(p => p.codigo === codigo);
                if (productoIndex === -1) {
                    showAlert('Producto no encontrado', 'error');
                    return;
                }
                
                // Reponer stock
                productos[productoIndex].stock += cantidad;
                
                // Registrar movimiento
                const nuevoMovimiento = {
                    tipo: 'reposicion',
                    producto: productos[productoIndex].nombre,
                    productoId: productos[productoIndex].firebaseKey,
                    cantidad: cantidad * (productos[productoIndex].unidadesPorMedida || 1),
                    fecha: new Date().toISOString(),
                    descripcion: descripcion || 'Reposición de stock',
                    responsable: 'Sistema'
                };
                
                movimientos.push(nuevoMovimiento);
                
                await saveData();
                actualizarInterfaz();
                showAlert(`Stock repuesto correctamente. Nuevo stock: ${productos[productoIndex].stock} ${productos[productoIndex].unidad}`, 'success');
                
                // Limpiar formulario
                document.getElementById('nuevoProductoForm')?.reset();
                document.getElementById('repositionBtn').style.display = 'none';
                document.getElementById('saveProductBtn').style.display = 'block';
                
            } catch (error) {
                console.error('Error al reponer stock:', error);
                showAlert('Error al reponer stock', 'error');
            }
        }

        function editarProducto(productoId) {
            showAlert('Función editarProducto() necesita implementación completa', 'error');
        }

        function confirmarEliminarProducto(productoId) {
            currentEditId = productoId;
            const modal = document.getElementById('confirmModal');
            if (modal) modal.style.display = 'flex';
        }

        async function eliminarProducto() {
            try {
                if (!currentEditId) return;
                
                const productoIndex = productos.findIndex(p => p.firebaseKey === currentEditId);
                if (productoIndex !== -1) {
                    productos.splice(productoIndex, 1);
                    await saveData();
                    actualizarInterfaz();
                    showAlert('Producto eliminado correctamente', 'success');
                }
                
                cerrarModal();
                currentEditId = null;
                
            } catch (error) {
                console.error('Error al eliminar producto:', error);
                showAlert('Error al eliminar producto', 'error');
            }
        }

        function ajustarStock(productoId) {
            currentAdjustId = productoId;
            const producto = productos.find(p => p.firebaseKey === productoId);
            if (!producto) return;
            
            const unidadesTotales = calcularUnidadesTotales(producto);
            
            document.getElementById('adjustProductName').value = producto.nombre;
            document.getElementById('adjustCurrentStock').value = `${unidadesTotales} unidades`;
            document.getElementById('adjustCurrentStockMedida').value = `${producto.stock} ${producto.unidad}`;
            
            const modal = document.getElementById('adjustModal');
            if (modal) modal.style.display = 'flex';
        }

        function limpiarFiltrosInventario() {
            document.getElementById('searchProduct').value = '';
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterStock').value = '';
            actualizarTablaInventario();
        }

        function limpiarFiltrosMovimientos() {
            document.getElementById('filterMovimiento').value = '';
            document.getElementById('filterMovDept').value = '';
            document.getElementById('filterMovFecha').value = '';
            actualizarTablaMovimientos();
        }

        function actualizarTablaMovimientos() {
            // Implementación simplificada
            const movimientosTableBody = document.getElementById('movimientosTableBody');
            if (!movimientosTableBody) return;
            
            movimientosTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">Función en desarrollo</td></tr>';
        }

        async function guardarCambiosMovimiento() {
            showAlert('Función guardarCambiosMovimiento() necesita implementación completa', 'error');
        }

        async function eliminarMovimiento() {
            showAlert('Función eliminarMovimiento() necesita implementación completa', 'error');
        }

        // Función para cargar datos iniciales
        async function loadInitialData() {
            showLoading('Cargando datos iniciales...');
            
            try {
                // Aquí irían los datos iniciales completos
                // Por ahora solo creamos un array vacío
                productos = [];
                movimientos = [];
                
                await saveData();
                actualizarInterfaz();
                hideLoading();
                showAlert('Datos iniciales cargados (vacío por ahora)', 'success');
                
            } catch (error) {
                console.error('Error al cargar datos iniciales:', error);
                hideLoading();
                showAlert('Error al cargar datos iniciales', 'error');
            }
        }

        // Función para limpiar todos los datos
        async function clearAllData() {
            showLoading('Limpiando base de datos...');
            
            try {
                productos = [];
                movimientos = [];
                
                await saveData();
                actualizarInterfaz();
                hideLoading();
                showAlert('Base de datos limpiada correctamente', 'success');
                
            } catch (error) {
                console.error('Error al limpiar base de datos:', error);
                hideLoading();
                showAlert('Error al limpiar base de datos', 'error');
            }
        }

    </script>
</body>
</html>
