<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Inventario - Artículos de Oficina</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, Timestamp, where } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDDh9GMKi2eOVI1OeuwaBiqlEhjGpphvvk",
            authDomain: "inventario-administracion.firebaseapp.com",
            projectId: "inventario-administracion",
            storageBucket: "inventario-administracion.firebasestorage.app",
            messagingSenderId: "927319095883",
            appId: "1:927319095883:web:7c49d3294d1149990d2bce"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Hacer disponibles globalmente las funciones de Firebase
        window.firebaseApp = app;
        window.firebaseDB = db;
        window.firebaseFunctions = {
            collection,
            addDoc,
            getDocs,
            updateDoc,
            deleteDoc,
            doc,
            onSnapshot,
            query,
            orderBy,
            Timestamp,
            where
        };
        
        console.log("Firebase inicializado correctamente");
    </script>
    
    <style>
        /* ESTILOS (se mantienen igual que en tu archivo original) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            font-size: 14px;
        }

        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 100%;
            overflow-x: hidden;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h1 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.4rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            opacity: 0.9;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stock-alert {
            background-color: #e74c3c;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }

        .stock-alert.show {
            display: block;
        }

        .main-content {
            display: flex;
            flex: 1;
            flex-direction: column;
        }

        @media (min-width: 768px) {
            .main-content {
                flex-direction: row;
            }
        }

        .sidebar {
            width: 100%;
            background-color: #2c3e50;
            color: white;
            padding: 1rem 0;
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 768px) {
            .sidebar {
                width: 250px;
                min-width: 250px;
            }
        }

        .menu {
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding: 0 1rem;
        }

        @media (max-width: 767px) {
            .menu {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .menu-btn {
                flex: 1;
                min-width: 120px;
                justify-content: center;
            }
        }

        .menu-btn {
            background: none;
            border: none;
            color: #ecf0f1;
            text-align: left;
            padding: 10px 12px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .menu-btn:hover {
            background-color: #34495e;
        }

        .menu-btn.active {
            background-color: #3498db;
            font-weight: 600;
        }

        .menu-divider {
            height: 1px;
            background-color: #4a6278;
            margin: 10px 0;
            width: 100%;
        }

        .export-btn {
            background-color: #27ae60;
        }

        .export-btn:hover {
            background-color: #219653;
        }

        .stats {
            margin-top: auto;
            padding: 1rem;
            background-color: #34495e;
            border-radius: 5px;
            margin: 1rem;
            display: none;
        }

        @media (min-width: 768px) {
            .stats {
                display: block;
            }
        }

        .stats h3 {
            font-size: 1rem;
            margin-bottom: 0.8rem;
            color: #ecf0f1;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.8rem;
        }

        .content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            width: 100%;
        }

        @media (min-width: 768px) {
            .content {
                padding: 1.5rem;
            }
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.4rem;
        }

        h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .filters {
            display: flex;
            gap: 8px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filters input, .filters select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.85rem;
            min-width: 0;
        }

        .filters input:focus, .filters select:focus {
            outline: none;
            border-color: #3498db;
        }

        #searchProduct {
            flex: 2;
            min-width: 150px;
        }

        #filterCategory, #filterDept, #filterDate {
            flex: 1;
            min-width: 120px;
        }

        #clearFilters {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        #clearFilters:hover {
            background-color: #c0392b;
        }

        .table-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            overflow: auto;
            max-height: 500px;
            width: 100%;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        thead {
            background-color: #3498db;
            color: white;
            position: sticky;
            top: 0;
        }

        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 0.85rem;
        }

        tbody tr:hover {
            background-color: #f5f9fc;
        }

        .stock-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .stock-low {
            background-color: #e74c3c;
            animation: pulse 2s infinite;
        }

        .stock-medium {
            background-color: #f39c12;
        }

        .stock-high {
            background-color: #27ae60;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .btn-action {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .btn-edit {
            background-color: #f39c12;
            color: white;
        }

        .btn-delete {
            background-color: #e74c3c;
            color: white;
        }

        .btn-assign {
            background-color: #3498db;
            color: white;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        @media (max-width: 480px) {
            .form-group {
                min-width: 100%;
            }
        }

        .form-group.full-width {
            flex: 100%;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.85rem;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
            font-size: 0.9rem;
            flex: 1;
            justify-content: center;
            min-width: 120px;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background-color: #219653;
        }

        .reports-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .report-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 15px;
            flex: 1;
            min-width: 300px;
        }

        @media (max-width: 767px) {
            .report-card {
                min-width: 100%;
            }
        }

        .report-card.full-width {
            flex: 100%;
        }

        .chart-container {
            height: 250px;
            margin-top: 15px;
            position: relative;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-box {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .stat-box i {
            font-size: 1.5rem;
            color: #3498db;
        }

        .stat-content h4 {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .stat-content p {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .report-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .report-controls select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            min-width: 150px;
            font-size: 0.85rem;
        }

        @media (max-width: 480px) {
            .report-controls select {
                min-width: 100%;
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: #3498db;
            color: white;
            border-radius: 8px 8px 0 0;
        }

        .close-modal {
            font-size: 1.3rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 15px;
        }

        .confirm-modal .modal-body {
            text-align: center;
            padding: 20px 15px;
        }

        .modal-footer {
            padding: 15px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            flex-wrap: wrap;
        }

        footer {
            background-color: #2c3e50;
            color: #ecf0f1;
            text-align: center;
            padding: 1rem;
            font-size: 0.8rem;
        }

        .product-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 15px;
            margin-bottom: 15px;
            border-left: 5px solid #3498db;
        }

        .product-card.low-stock {
            border-left-color: #e74c3c;
        }

        .product-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .product-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: #2c3e50;
        }

        .product-category {
            background-color: #e3f2fd;
            color: #3498db;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
        }

        .product-stock {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .stock-progress {
            height: 8px;
            background-color: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .stock-progress-bar {
            height: 100%;
            background-color: #27ae60;
            transition: width 0.3s;
        }

        .stock-progress-bar.low {
            background-color: #e74c3c;
        }

        .stock-progress-bar.medium {
            background-color: #f39c12;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 5px;
        }
        
        .badge-papeleria {
            background-color: #e3f2fd;
            color: #3498db;
        }
        
        .badge-toner {
            background-color: #e8f5e9;
            color: #27ae60;
        }
        
        .badge-oficina {
            background-color: #fff3cd;
            color: #f39c12;
        }
        
        .badge-electronica {
            background-color: #f3e5f5;
            color: #9b59b6;
        }
        
        .badge-otros {
            background-color: #e9ecef;
            color: #6c757d;
        }
        
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .dashboard-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        
        .dashboard-card i {
            font-size: 2rem;
            color: #3498db;
            margin-bottom: 10px;
        }
        
        .dashboard-card h3 {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .dashboard-card p {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .dashboard-card.warning {
            background-color: #fff3cd;
            border-left: 5px solid #f39c12;
        }
        
        .dashboard-card.danger {
            background-color: #f8d7da;
            border-left: 5px solid #e74c3c;
        }
        
        /* Nuevos estilos para la gestión de unidades */
        .unit-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 3px;
        }
        
        .unit-badge {
            background-color: #e8f4fd;
            color: #3498db;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 5px;
        }
        
        .unit-conversion {
            font-size: 0.75rem;
            color: #7f8c8d;
            font-style: italic;
        }
        
        .stock-details {
            display: flex;
            flex-direction: column;
        }
        
        .stock-total {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .unit-assignment {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border-left: 3px solid #3498db;
        }
        
        .unit-assignment h4 {
            font-size: 0.9rem;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .unit-calc {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .unit-calc input {
            width: 80px;
        }
        
        .unit-result {
            background-color: #e9ecef;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        /* Estilos para departamentos largos */
        .department-select {
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* Estilos para el botón de reposición */
        .btn-reposition {
            background-color: #9b59b6;
            color: white;
        }
        
        .btn-reposition:hover {
            background-color: #8e44ad;
        }
        
        /* Firebase status indicator */
        .firebase-status {
            position: fixed;
            bottom: 60px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .firebase-status.offline {
            background: #e74c3c;
        }
        
        .firebase-status .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-boxes"></i> Sistema de Inventario - Artículos de Oficina</h1>
            <div class="header-info">
                <div class="date-time" id="currentDateTime"></div>
                <div class="total-products">Productos: <span id="totalProducts">0</span></div>
                <div class="firebase-status" id="firebaseStatus" style="display: none;">
                    <span class="status-dot"></span>
                    <span>Conectado a Firebase</span>
                </div>
            </div>
            <div class="stock-alert" id="stockAlert">
                <i class="fas fa-exclamation-triangle"></i> 
                <span id="alertMessage">Hay productos con stock bajo. Verifique el inventario.</span>
            </div>
        </header>

        <div class="main-content">
            <div class="sidebar">
                <div class="menu">
                    <button class="menu-btn active" data-section="dashboard">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </button>
                    <button class="menu-btn" data-section="inventario">
                        <i class="fas fa-clipboard-list"></i> Inventario
                    </button>
                    <button class="menu-btn" data-section="nuevo-producto">
                        <i class="fas fa-plus"></i> Nuevo Producto
                    </button>
                    <button class="menu-btn" data-section="asignacion">
                        <i class="fas fa-hand-holding"></i> Asignar Material
                    </button>
                    <button class="menu-btn" data-section="movimientos">
                        <i class="fas fa-exchange-alt"></i> Movimientos
                    </button>
                    <button class="menu-btn" data-section="reportes">
                        <i class="fas fa-chart-bar"></i> Reportes
                    </button>
                    <div class="menu-divider"></div>
                    <button class="menu-btn export-btn" id="exportPdf">
                        <i class="fas fa-file-pdf"></i> Exportar PDF
                    </button>
                    <button class="menu-btn export-btn" id="exportExcel">
                        <i class="fas fa-file-excel"></i> Exportar Excel
                    </button>
                    <button class="menu-btn export-btn" id="exportInventoryExcel">
                        <i class="fas fa-file-excel"></i> Inventario Actual
                    </button>
                    <button class="menu-btn export-btn" id="syncData" style="background-color: #9b59b6;">
                        <i class="fas fa-sync-alt"></i> Sincronizar
                    </button>
                </div>

                <div class="stats">
                    <h3>Resumen del Inventario</h3>
                    <div class="stat-item">
                        <span>Productos bajos:</span>
                        <strong id="lowStockCount">0</strong>
                    </div>
                    <div class="stat-item">
                        <span>Asignaciones hoy:</span>
                        <strong id="todayAssignments">0</strong>
                    </div>
                    <div class="stat-item">
                        <span>Stock total (unidades):</span>
                        <strong id="totalStock">0</strong>
                    </div>
                </div>
            </div>

            <div class="content">
                <!-- Sección Dashboard -->
                <section id="dashboard" class="content-section active">
                    <h2><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
                    
                    <div class="dashboard-cards">
                        <div class="dashboard-card">
                            <i class="fas fa-boxes"></i>
                            <h3 id="dashboardTotalProducts">0</h3>
                            <p>Productos en Inventario</p>
                        </div>
                        
                        <div class="dashboard-card warning" id="lowStockCard">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3 id="dashboardLowStock">0</h3>
                            <p>Productos con Stock Bajo</p>
                        </div>
                        
                        <div class="dashboard-card">
                            <i class="fas fa-hand-holding"></i>
                            <h3 id="dashboardTotalAssignments">0</h3>
                            <p>Asignaciones este Mes</p>
                        </div>
                        
                        <div class="dashboard-card">
                            <i class="fas fa-calculator"></i>
                            <h3 id="dashboardTotalUnits">0</h3>
                            <p>Total Unidades Disponibles</p>
                        </div>
                    </div>
                    
                    <div class="reports-container">
                        <div class="report-card">
                            <h3>Stock por Categoría</h3>
                            <div class="chart-container">
                                <canvas id="categoryChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="report-card">
                            <h3>Productos con Stock Bajo</h3>
                            <div id="lowStockList">
                                <p style="text-align: center; color: #666; padding: 20px;">Cargando datos...</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Sección de Inventario -->
                <section id="inventario" class="content-section">
                    <h2><i class="fas fa-clipboard-list"></i> Inventario de Productos</h2>
                    <div class="filters">
                        <input type="text" id="searchProduct" placeholder="Buscar producto...">
                        <select id="filterCategory">
                            <option value="">Todas las Categorías</option>
                            <option value="papeleria">Papelería</option>
                            <option value="oficina">Artículos de Oficina</option>
                            <option value="toner">Toner</option>
                            <option value="electronica">Electrónica</option>
                            <option value="limpieza">Limpieza</option>
                            <option value="otros">Otros</option>
                        </select>
                        <select id="filterStock">
                            <option value="">Todo el Stock</option>
                            <option value="low">Stock Bajo</option>
                            <option value="normal">Stock Normal</option>
                            <option value="alto">Stock Alto</option>
                        </select>
                        <button id="clearFilters"><i class="fas fa-times"></i> Limpiar filtros</button>
                    </div>
                    <div class="table-container">
                        <table id="inventarioTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Producto</th>
                                    <th>Categoría</th>
                                    <th>Stock</th>
                                    <th>Unidades Totales</th>
                                    <th>Unidad</th>
                                    <th>Stock Mínimo</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="inventarioTableBody">
                                <tr><td colspan="9" style="text-align: center; padding: 20px;">Cargando datos de Firebase...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Sección de Nuevo Producto -->
                <section id="nuevo-producto" class="content-section">
                    <h2><i class="fas fa-plus"></i> Registrar/Reponer Producto</h2>
                    <form id="nuevoProductoForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="codigoProducto">Código del Producto *</label>
                                <input type="text" id="codigoProducto" placeholder="Ej: OFI-001" required>
                                <small class="unit-conversion">Para reponer, use el código existente</small>
                            </div>
                            <div class="form-group">
                                <label for="nombreProducto">Nombre del Producto *</label>
                                <input type="text" id="nombreProducto" placeholder="Ej: Bolígrafos" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="categoriaProducto">Categoría *</label>
                                <select id="categoriaProducto" required>
                                    <option value="">Seleccione...</option>
                                    <option value="papeleria">Papelería</option>
                                    <option value="oficina">Artículos de Oficina</option>
                                    <option value="toner">Toner</option>
                                    <option value="electronica">Electrónica</option>
                                    <option value="limpieza">Limpieza</option>
                                    <option value="otros">Otros</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="unidadProducto">Unidad de Medida *</label>
                                <select id="unidadProducto" required>
                                    <option value="">Seleccione...</option>
                                    <option value="UND">Unidades</option>
                                    <option value="CAJAS">Cajas</option>
                                    <option value="PAQ">Paquetes</option>
                                    <option value="GALON">Galones</option>
                                    <option value="LT">Litros</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="unidadesPorMedida">Unidades por Medida *</label>
                                <input type="number" id="unidadesPorMedida" min="1" value="1" required>
                                <small class="unit-conversion">Ej: 24 unidades por caja, 100 unidades por paquete</small>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="stockInicial">Stock a Agregar *</label>
                                <input type="number" id="stockInicial" min="0" required>
                                <small class="unit-conversion">En la unidad de medida seleccionada</small>
                            </div>
                            <div class="form-group">
                                <label for="stockMinimo">Stock Mínimo (Alerta) *</label>
                                <input type="number" id="stockMinimo" min="1" value="5" required>
                                <small class="unit-conversion">En la unidad de medida seleccionada</small>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="descripcionProducto">Descripción / Motivo</label>
                                <textarea id="descripcionProducto" rows="3" placeholder="Detalles del producto o motivo de reposición..."></textarea>
                            </div>
                        </div>

                        <div class="form-buttons">
                            <button type="submit" class="btn btn-primary" id="saveProductBtn">
                                <i class="fas fa-save"></i> Guardar Producto
                            </button>
                            <button type="button" class="btn btn-success" id="repositionBtn" style="display: none;">
                                <i class="fas fa-boxes"></i> Reponer Stock
                            </button>
                            <button type="reset" class="btn btn-secondary" id="resetProductBtn">
                                <i class="fas fa-redo"></i> Limpiar
                            </button>
                        </div>
                    </form>
                </section>

                <!-- Sección de Asignación de Material -->
                <section id="asignacion" class="content-section">
                    <h2><i class="fas fa-hand-holding"></i> Asignar Material a Departamentos</h2>
                    <form id="asignacionForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="productoAsignar">Producto *</label>
                                <select id="productoAsignar" required>
                                    <option value="">Seleccione...</option>
                                    <!-- Los productos se cargarán dinámicamente -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="stockDisponible">Stock Disponible (Unidades)</label>
                                <input type="text" id="stockDisponible" readonly style="background-color: #f5f5f5;">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="departamentoAsignar">Departamento *</label>
                                <select id="departamentoAsignar" class="department-select" required>
                                    <option value="">Seleccione...</option>
                                    <option value="Administración">Administración</option>
                                    <option value="Tesorería">Tesorería</option>
                                    <option value="RRHH">RRHH</option>
                                    <option value="Flota">Flota</option>
                                    <option value="Almacén">Almacén</option>
                                    <option value="Head End">Head End</option>
                                    <option value="Seguridad Laboral">Seguridad Laboral</option>
                                    <option value="Gerencia senior">Gerencia senior</option>
                                    <option value="Sistemas">Sistemas</option>
                                    <option value="Colaboradores">Colaboradores</option>
                                    <option value="Los Ruices">Los Ruices</option>
                                    <option value="El Rosal">El Rosal</option>
                                    <option value="La Naya">La Naya</option>
                                    <option value="TDH">TDH</option>
                                    <option value="Obras">Obras</option>
                                    <option value="Comerciales">Comerciales</option>
                                    <option value="Obras Corporativo">Obras Corporativo</option>
                                    <option value="MSO">MSO</option>
                                    <option value="El Paraiso">El Paraiso</option>
                                    <option value="Backbone">Backbone</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="usuarioAsignar">Usuario que Recibe *</label>
                                <input type="text" id="usuarioAsignar" placeholder="Nombre del usuario" required>
                            </div>
                        </div>

                        <div class="unit-assignment">
                            <h4>Asignación por Unidades</h4>
                            <div class="unit-calc">
                                <div>
                                    <label for="cantidadAsignarUnidades">Cantidad en Unidades *</label>
                                    <input type="number" id="cantidadAsignarUnidades" min="1" required>
                                </div>
                                <div>
                                    <label>Equivalencia:</label>
                                    <div class="unit-result" id="equivalenciaUnidades">0 unidades</div>
                                </div>
                                <div>
                                    <label>Nuevo Stock:</label>
                                    <div class="unit-result" id="nuevoStockUnidades">0 unidades</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="fechaAsignacion">Fecha de Asignación *</label>
                                <input type="datetime-local" id="fechaAsignacion" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="observacionesAsignacion">Observaciones</label>
                                <textarea id="observacionesAsignacion" rows="3" placeholder="Detalles de la asignación..."></textarea>
                            </div>
                        </div>

                        <div class="form-buttons">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-check"></i> Registrar Asignación
                            </button>
                            <button type="reset" class="btn btn-secondary">
                                <i class="fas fa-redo"></i> Limpiar
                            </button>
                        </div>
                    </form>
                </section>

                <!-- Sección de Movimientos -->
                <section id="movimientos" class="content-section">
                    <h2><i class="fas fa-exchange-alt"></i> Historial de Movimientos</h2>
                    <div class="filters">
                        <select id="filterMovimiento">
                            <option value="">Todos los Movimientos</option>
                            <option value="entrada">Entradas</option>
                            <option value="salida">Salidas/Asignaciones</option>
                            <option value="ajuste">Ajustes</option>
                            <option value="reposicion">Reposiciones</option>
                        </select>
                        <select id="filterMovDept" class="department-select">
                            <option value="">Todos los Departamentos</option>
                            <!-- Los departamentos se cargarán dinámicamente -->
                        </select>
                        <input type="date" id="filterMovFecha">
                        <button id="clearMovFilters"><i class="fas fa-times"></i> Limpiar filtros</button>
                    </div>
                    <div class="table-container">
                        <table id="movimientosTable">
                            <thead>
                                <tr>
                                    <th>Fecha y Hora</th>
                                    <th>Tipo</th>
                                    <th>Producto</th>
                                    <th>Cantidad (Unidades)</th>
                                    <th>Departamento</th>
                                    <th>Usuario</th>
                                    <th>Observaciones</th>
                                    <th>Responsable</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="movimientosTableBody">
                                <tr><td colspan="9" style="text-align: center; padding: 20px;">Cargando datos de Firebase...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Sección de Reportes -->
                <section id="reportes" class="content-section">
                    <h2><i class="fas fa-chart-bar"></i> Reportes y Estadísticas</h2>
                    
                    <div class="report-controls">
                        <select id="reportType">
                            <option value="mensual">Reporte Mensual</option>
                            <option value="anual">Reporte Anual</option>
                            <option value="departamento">Por Departamento</option>
                            <option value="productos">Por Producto</option>
                        </select>
                        <select id="reportMonth">
                            <!-- Los meses se cargarán dinámicamente -->
                        </select>
                        <select id="reportYear">
                            <!-- Los años se cargarán dinámicamente -->
                        </select>
                        <button id="generateReport" class="btn btn-primary">
                            <i class="fas fa-chart-bar"></i> Generar Reporte
                        </button>
                        <button id="exportReportExcel" class="btn btn-success">
                            <i class="fas fa-file-excel"></i> Exportar Reporte
                        </button>
                    </div>

                    <div class="reports-container">
                        <div class="report-card">
                            <h3 id="chartTitle1">Consumo por Departamento (Unidades)</h3>
                            <div class="chart-container">
                                <canvas id="deptChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="report-card">
                            <h3 id="chartTitle2">Top 10 Productos Más Utilizados (Unidades)</h3>
                            <div class="chart-container">
                                <canvas id="topProductsChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="report-card full-width">
                            <h3>Resumen de Movimientos</h3>
                            <div id="resumenAsignaciones">
                                <p style="text-align: center; color: #666; padding: 20px;">Cargando datos...</p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Modal para editar producto -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Editar Producto</h3>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <!-- El formulario de edición se cargará aquí -->
                </div>
            </div>
        </div>

        <!-- Modal para ajustar stock -->
        <div id="adjustModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Ajustar Stock por Unidades</h3>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="adjustStockForm">
                        <div class="form-group">
                            <label for="adjustProductName">Producto</label>
                            <input type="text" id="adjustProductName" readonly>
                        </div>
                        <div class="form-group">
                            <label for="adjustCurrentStock">Stock Actual (Unidades)</label>
                            <input type="text" id="adjustCurrentStock" readonly>
                        </div>
                        <div class="form-group">
                            <label for="adjustCurrentStockMedida">Stock Actual (Medida)</label>
                            <input type="text" id="adjustCurrentStockMedida" readonly>
                        </div>
                        <div class="form-group">
                            <label for="adjustType">Tipo de Ajuste *</label>
                            <select id="adjustType" required>
                                <option value="entrada">Entrada (Agregar)</option>
                                <option value="salida">Salida (Retirar)</option>
                                <option value="reposicion">Reposición</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="adjustQuantity">Cantidad en Unidades *</label>
                            <input type="number" id="adjustQuantity" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="adjustReason">Motivo *</label>
                            <textarea id="adjustReason" rows="3" required></textarea>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="btn btn-primary">Aplicar Ajuste</button>
                            <button type="button" class="btn btn-secondary close-modal">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal de confirmación para eliminación de producto -->
        <div id="confirmModal" class="modal">
            <div class="modal-content confirm-modal">
                <div class="modal-header">
                    <h3>Confirmar Eliminación</h3>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <p>¿Está seguro de que desea eliminar este producto? Esta acción eliminará también todos los movimientos asociados.</p>
                </div>
                <div class="modal-footer">
                    <button id="confirmDelete" class="btn btn-danger">Eliminar</button>
                    <button id="cancelDelete" class="btn btn-secondary">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Modal de confirmación para eliminación de movimiento -->
        <div id="confirmMovModal" class="modal">
            <div class="modal-content confirm-modal">
                <div class="modal-header">
                    <h3>Confirmar Eliminación de Movimiento</h3>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <p id="confirmMovMessage">¿Está seguro de que desea eliminar este movimiento? Esta acción revertirá el stock afectado.</p>
                </div>
                <div class="modal-footer">
                    <button id="confirmMovDelete" class="btn btn-danger">Eliminar</button>
                    <button id="cancelMovDelete" class="btn btn-secondary">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- Modal para editar movimiento -->
        <div id="editMovModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Editar Movimiento</h3>
                    <span class="close-modal">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="editMovForm">
                        <div class="form-group">
                            <label for="editMovProducto">Producto</label>
                            <input type="text" id="editMovProducto" readonly>
                        </div>
                        <div class="form-group">
                            <label for="editMovTipo">Tipo</label>
                            <input type="text" id="editMovTipo" readonly>
                        </div>
                        <div class="form-group">
                            <label for="editMovCantidad">Cantidad (Unidades)</label>
                            <input type="text" id="editMovCantidad" readonly>
                        </div>
                        <div class="form-group" id="editMovDeptGroup">
                            <label for="editMovDepartamento">Departamento</label>
                            <input type="text" id="editMovDepartamento">
                        </div>
                        <div class="form-group">
                            <label for="editMovUsuario">Usuario</label>
                            <input type="text" id="editMovUsuario">
                        </div>
                        <div class="form-group">
                            <label for="editMovObservaciones">Observaciones</label>
                            <textarea id="editMovObservaciones" rows="3"></textarea>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                            <button type="button" class="btn btn-secondary close-modal">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <footer>
            <p>Sistema de Inventario - Artículos de Oficina &copy; 2024 | <span id="lastUpdate"></span> | Firebase: <span id="firebaseConnectionStatus">Conectando...</span></p>
        </footer>
    </div>

    <script>
        // =============================================
        // MEJORAS PARA GITHUB Y FIREBASE
        // 1. Integración completa con Firebase Firestore
        // 2. Sincronización en tiempo real
        // 3. Estado de conexión visible
        // 4. Datos persistentes en la nube
        // =============================================

        // Variables globales
        let productos = [];
        let movimientos = [];
        let currentEditId = null;
        let currentAdjustId = null;
        let currentMovEditId = null;
        let nextProductId = 1;
        let nextMovimientoId = 1;
        let categoryChartInstance = null;
        let deptChartInstance = null;
        let topProductsChartInstance = null;
        let isFirebaseInitialized = false;
        let firebaseUnsubscribeProducts = null;
        let firebaseUnsubscribeMovimientos = null;

        // Departamentos disponibles
        const departamentos = [
            "Administración",
            "Tesorería",
            "RRHH",
            "Flota",
            "Almacén",
            "Head End",
            "Seguridad Laboral",
            "Gerencia senior",
            "Sistemas",
            "Colaboradores",
            "Los Ruices",
            "El Rosal",
            "La Naya",
            "TDH",
            "Obras",
            "Comerciales",
            "Obras Corporativo",
            "MSO",
            "El Paraiso",
            "Backbone"
        ];

        // =============================================
        // FUNCIONES DE FIREBASE
        // =============================================

        // Función para inicializar Firebase
        async function initializeFirebase() {
            try {
                // Verificar si Firebase ya está inicializado
                if (window.firebaseDB && window.firebaseFunctions) {
                    console.log("Firebase ya está inicializado");
                    isFirebaseInitialized = true;
                    updateFirebaseStatus(true);
                    
                    // Cargar datos iniciales
                    await loadInitialData();
                    
                    // Configurar listeners en tiempo real
                    setupRealtimeListeners();
                    
                    // Inicializar sistema
                    inicializarSistema();
                    
                    return true;
                } else {
                    console.log("Esperando inicialización de Firebase...");
                    setTimeout(initializeFirebase, 1000);
                    return false;
                }
            } catch (error) {
                console.error("Error inicializando Firebase:", error);
                updateFirebaseStatus(false);
                return false;
            }
        }

        // Cargar datos iniciales desde Firebase
        async function loadInitialData() {
            try {
                const { getDocs, collection, query, orderBy } = window.firebaseFunctions;
                const db = window.firebaseDB;
                
                // Cargar productos
                const productosSnapshot = await getDocs(query(collection(db, "productos"), orderBy("id")));
                productos = [];
                productosSnapshot.forEach((doc) => {
                    productos.push({...doc.data(), firebaseId: doc.id});
                });
                
                // Cargar movimientos
                const movimientosSnapshot = await getDocs(query(collection(db, "movimientos"), orderBy("fechaHora", "desc")));
                movimientos = [];
                movimientosSnapshot.forEach((doc) => {
                    movimientos.push({...doc.data(), firebaseId: doc.id});
                });
                
                // Actualizar IDs
                if (productos.length > 0) {
                    nextProductId = Math.max(...productos.map(p => p.id)) + 1;
                }
                if (movimientos.length > 0) {
                    nextMovimientoId = Math.max(...movimientos.map(m => m.id)) + 1;
                }
                
                console.log(`Datos cargados: ${productos.length} productos, ${movimientos.length} movimientos`);
                return true;
            } catch (error) {
                console.error("Error cargando datos iniciales:", error);
                return false;
            }
        }

        // Configurar listeners en tiempo real
        function setupRealtimeListeners() {
            try {
                const { onSnapshot, collection, query, orderBy } = window.firebaseFunctions;
                const db = window.firebaseDB;
                
                // Listener para productos
                firebaseUnsubscribeProducts = onSnapshot(
                    query(collection(db, "productos"), orderBy("id")),
                    (snapshot) => {
                        productos = [];
                        snapshot.forEach((doc) => {
                            productos.push({...doc.data(), firebaseId: doc.id});
                        });
                        
                        // Actualizar IDs
                        if (productos.length > 0) {
                            nextProductId = Math.max(...productos.map(p => p.id)) + 1;
                        }
                        
                        // Actualizar UI
                        actualizarTablaInventario();
                        cargarProductosAsignacion();
                        actualizarEstadisticas();
                        actualizarDashboard();
                        verificarStockBajo();
                        
                        console.log("Productos actualizados en tiempo real");
                    },
                    (error) => {
                        console.error("Error en listener de productos:", error);
                    }
                );
                
                // Listener para movimientos
                firebaseUnsubscribeMovimientos = onSnapshot(
                    query(collection(db, "movimientos"), orderBy("fechaHora", "desc")),
                    (snapshot) => {
                        movimientos = [];
                        snapshot.forEach((doc) => {
                            movimientos.push({...doc.data(), firebaseId: doc.id});
                        });
                        
                        // Actualizar IDs
                        if (movimientos.length > 0) {
                            nextMovimientoId = Math.max(...movimientos.map(m => m.id)) + 1;
                        }
                        
                        // Actualizar UI
                        actualizarTablaMovimientos();
                        actualizarEstadisticas();
                        actualizarDashboard();
                        
                        console.log("Movimientos actualizados en tiempo real");
                    },
                    (error) => {
                        console.error("Error en listener de movimientos:", error);
                    }
                );
                
                console.log("Listeners de Firebase configurados");
            } catch (error) {
                console.error("Error configurando listeners:", error);
            }
        }

        // Guardar producto en Firebase
        async function saveProductToFirebase(producto) {
            try {
                const { addDoc, collection } = window.firebaseFunctions;
                const db = window.firebaseDB;
                
                const docRef = await addDoc(collection(db, "productos"), producto);
                console.log("Producto guardado en Firebase:", producto.codigo, "ID:", docRef.id);
                return docRef.id;
            } catch (error) {
                console.error("Error guardando producto en Firebase:", error);
                return null;
            }
        }

        // Actualizar producto en Firebase
        async function updateProductInFirebase(firebaseId, updates) {
            try {
                const { updateDoc, doc } = window.firebaseFunctions;
                const db = window.firebaseDB;
                
                await updateDoc(doc(db, "productos", firebaseId), updates);
                console.log("Producto actualizado en Firebase:", firebaseId);
                return true;
            } catch (error) {
                console.error("Error actualizando producto en Firebase:", error);
                return false;
            }
        }

        // Eliminar producto de Firebase
        async function deleteProductFromFirebase(firebaseId) {
            try {
                const { deleteDoc, doc } = window.firebaseFunctions;
                const db = window.firebaseDB;
                
                await deleteDoc(doc(db, "productos", firebaseId));
                console.log("Producto eliminado de Firebase:", firebaseId);
                return true;
            } catch (error) {
                console.error("Error eliminando producto de Firebase:", error);
                return false;
            }
        }

        // Eliminar movimientos asociados a un producto
        async function deleteMovementsByProductId(productoId) {
            try {
                const { getDocs, collection, query, where, deleteDoc, doc } = window.firebaseFunctions;
                const db = window.firebaseDB;
                
                const movimientosQuery = query(collection(db, "movimientos"), where("productoId", "==", productoId));
                const querySnapshot = await getDocs(movimientosQuery);
                
                const deletePromises = [];
                querySnapshot.forEach((document) => {
                    deletePromises.push(deleteDoc(doc(db, "movimientos", document.id)));
                });
                
                await Promise.all(deletePromises);
                console.log(`Movimientos del producto ${productoId} eliminados: ${deletePromises.length}`);
                return true;
            } catch (error) {
                console.error("Error eliminando movimientos del producto:", error);
                return false;
            }
        }

        // Guardar movimiento en Firebase
        async function saveMovementToFirebase(movimiento) {
            try {
                const { addDoc, collection } = window.firebaseFunctions;
                const db = window.firebaseDB;
                
                const docRef = await addDoc(collection(db, "movimientos"), movimiento);
                console.log("Movimiento guardado en Firebase:", movimiento.id, "ID:", docRef.id);
                return docRef.id;
            } catch (error) {
                console.error("Error guardando movimiento en Firebase:", error);
                return null;
            }
        }

        // Actualizar movimiento en Firebase
        async function updateMovementInFirebase(firebaseId, updates) {
            try {
                const { updateDoc, doc } = window.firebaseFunctions;
                const db = window.firebaseDB;
                
                await updateDoc(doc(db, "movimientos", firebaseId), updates);
                console.log("Movimiento actualizado en Firebase:", firebaseId);
                return true;
            } catch (error) {
                console.error("Error actualizando movimiento en Firebase:", error);
                return false;
            }
        }

        // Eliminar movimiento de Firebase
        async function deleteMovementFromFirebase(firebaseId) {
            try {
                const { deleteDoc, doc } = window.firebaseFunctions;
                const db = window.firebaseDB;
                
                await deleteDoc(doc(db, "movimientos", firebaseId));
                console.log("Movimiento eliminado de Firebase:", firebaseId);
                return true;
            } catch (error) {
                console.error("Error eliminando movimiento de Firebase:", error);
                return false;
            }
        }

        // Sincronizar datos manualmente
        async function syncData() {
            const syncBtn = document.getElementById('syncData');
            const originalText = syncBtn.innerHTML;
            
            syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sincronizando...';
            syncBtn.disabled = true;
            
            try {
                await loadInitialData();
                
                // Actualizar UI
                actualizarTablaInventario();
                actualizarTablaMovimientos();
                cargarProductosAsignacion();
                actualizarEstadisticas();
                actualizarDashboard();
                verificarStockBajo();
                
                alert('Datos sincronizados correctamente con Firebase');
                updateFirebaseStatus(true);
            } catch (error) {
                console.error("Error sincronizando datos:", error);
                alert('Error al sincronizar datos con Firebase');
                updateFirebaseStatus(false);
            } finally {
                syncBtn.innerHTML = originalText;
                syncBtn.disabled = false;
            }
        }

        // Actualizar estado de Firebase en UI
        function updateFirebaseStatus(isConnected) {
            const statusElement = document.getElementById('firebaseStatus');
            const connectionStatus = document.getElementById('firebaseConnectionStatus');
            
            if (isConnected) {
                if (statusElement) {
                    statusElement.style.display = 'flex';
                    statusElement.classList.remove('offline');
                    statusElement.innerHTML = '<span class="status-dot"></span><span>Conectado a Firebase</span>';
                }
                if (connectionStatus) {
                    connectionStatus.textContent = 'Conectado';
                    connectionStatus.style.color = '#27ae60';
                }
            } else {
                if (statusElement) {
                    statusElement.style.display = 'flex';
                    statusElement.classList.add('offline');
                    statusElement.innerHTML = '<span class="status-dot"></span><span>Desconectado de Firebase</span>';
                }
                if (connectionStatus) {
                    connectionStatus.textContent = 'Desconectado';
                    connectionStatus.style.color = '#e74c3c';
                }
            }
        }

        // =============================================
        // FUNCIONES AUXILIARES
        // =============================================

        function calcularUnidadesTotales(producto) {
            return producto.stock * producto.unidadesPorMedida;
        }

        function calcularStockDesdeUnidades(producto, unidadesTotales) {
            if (producto.unidadesPorMedida === 0 || producto.unidadesPorMedida === undefined) {
                console.warn(`Producto ${producto.nombre} tiene unidadesPorMedida = 0, usando 1 como valor por defecto`);
                return unidadesTotales;
            }
            return unidadesTotales / producto.unidadesPorMedida;
        }

        function formatearFechaHora(fechaHoraStr = null) {
            const ahora = fechaHoraStr ? new Date(fechaHoraStr) : new Date();
            const fecha = ahora.toISOString().split('T')[0];
            const hora = ahora.toTimeString().split(' ')[0].substring(0, 8);
            return `${fecha} ${hora}`;
        }

        // =============================================
        // INICIALIZACIÓN DEL SISTEMA
        // =============================================

        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar Firebase primero
            initializeFirebase();
            
            // Configuración básica
            actualizarFechaHora();
            setInterval(actualizarFechaHora, 1000);
            
            generarOpcionesFechaReporte();
            configurarEventos();
            
            // Establecer fecha y hora actual por defecto
            const fechaInput = document.getElementById('fechaAsignacion');
            if (fechaInput) {
                const ahora = new Date();
                ahora.setMinutes(ahora.getMinutes() - ahora.getTimezoneOffset());
                fechaInput.value = ahora.toISOString().slice(0, 16);
            }
            
            // Configurar evento para cálculo de equivalencia en asignación
            const cantidadInput = document.getElementById('cantidadAsignarUnidades');
            if (cantidadInput) {
                cantidadInput.addEventListener('input', calcularEquivalenciaAsignacion);
            }
            
            // Configurar evento para verificar código existente
            const codigoInput = document.getElementById('codigoProducto');
            if (codigoInput) {
                codigoInput.addEventListener('blur', verificarCodigoExistente);
            }
            
            // Actualizar fecha de última actualización
            document.getElementById('lastUpdate').textContent = new Date().toLocaleDateString();
        });

        // Inicializar el sistema después de Firebase
        function inicializarSistema() {
            // Cargar productos en el select de asignación
            cargarProductosAsignacion();
            
            // Cargar departamentos en filtros
            cargarDepartamentosFiltros();
            
            // Mostrar la sección activa
            mostrarSeccion('dashboard');
            
            // Actualizar la tabla de inventario
            actualizarTablaInventario();
            
            // Actualizar la tabla de movimientos
            actualizarTablaMovimientos();
            
            // Actualizar estadísticas
            actualizarEstadisticas();
            
            // Actualizar dashboard
            actualizarDashboard();
            
            // Generar reporte inicial
            setTimeout(() => {
                generarReporteMensual();
            }, 500);
        }

        // =============================================
        // FUNCIONES DEL SISTEMA (modificadas para Firebase)
        // =============================================

        // Configurar eventos
        function configurarEventos() {
            // Navegación del menú
            document.querySelectorAll('.menu-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    mostrarSeccion(section);
                    
                    document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    if (section === 'reportes') {
                        setTimeout(() => {
                            const reportType = document.getElementById('reportType').value;
                            if (reportType === 'mensual') {
                                generarReporteMensual();
                            } else if (reportType === 'anual') {
                                generarReporteAnual();
                            } else if (reportType === 'departamento') {
                                generarReporteDepartamento();
                            } else {
                                generarReporteProductos();
                            }
                        }, 100);
                    }
                    
                    if (section === 'dashboard') {
                        setTimeout(() => {
                            actualizarDashboard();
                        }, 100);
                    }
                });
            });
            
            // Formulario de nuevo producto
            document.getElementById('nuevoProductoForm').addEventListener('submit', guardarProducto);
            
            // Botón de reposición
            document.getElementById('repositionBtn').addEventListener('click', function(e) {
                e.preventDefault();
                guardarReposicion();
            });
            
            // Formulario de asignación
            document.getElementById('asignacionForm').addEventListener('submit', registrarAsignacion);
            
            // Select de producto en asignación
            document.getElementById('productoAsignar').addEventListener('change', function() {
                const productoId = this.value;
                if (productoId) {
                    const producto = productos.find(p => p.id == productoId);
                    if (producto) {
                        const unidadesTotales = calcularUnidadesTotales(producto);
                        document.getElementById('stockDisponible').value = `${unidadesTotales} unidades`;
                        calcularEquivalenciaAsignacion();
                    }
                } else {
                    document.getElementById('stockDisponible').value = '';
                    document.getElementById('equivalenciaUnidades').textContent = '0 unidades';
                    document.getElementById('nuevoStockUnidades').textContent = '0 unidades';
                }
            });
            
            // Botón limpiar filtros inventario
            document.getElementById('clearFilters').addEventListener('click', limpiarFiltrosInventario);
            
            // Botón limpiar filtros movimientos
            document.getElementById('clearMovFilters').addEventListener('click', limpiarFiltrosMovimientos);
            
            // Filtros de búsqueda inventario
            document.getElementById('searchProduct').addEventListener('input', actualizarTablaInventario);
            document.getElementById('filterCategory').addEventListener('change', actualizarTablaInventario);
            document.getElementById('filterStock').addEventListener('change', actualizarTablaInventario);
            
            // Filtros de movimientos
            document.getElementById('filterMovimiento').addEventListener('change', actualizarTablaMovimientos);
            document.getElementById('filterMovDept').addEventListener('change', actualizarTablaMovimientos);
            document.getElementById('filterMovFecha').addEventListener('change', actualizarTablaMovimientos);
            
            // Tipo de reporte
            document.getElementById('reportType').addEventListener('change', function() {
                const monthSelect = document.getElementById('reportMonth');
                
                if (this.value === 'departamento' || this.value === 'productos') {
                    monthSelect.style.display = 'none';
                } else {
                    monthSelect.style.display = 'block';
                }
            });
            
            // Generar reporte
            document.getElementById('generateReport').addEventListener('click', function() {
                const reportType = document.getElementById('reportType').value;
                if (reportType === 'mensual') {
                    generarReporteMensual();
                } else if (reportType === 'anual') {
                    generarReporteAnual();
                } else if (reportType === 'departamento') {
                    generarReporteDepartamento();
                } else {
                    generarReporteProductos();
                }
            });
            
            // Exportar reporte Excel
            document.getElementById('exportReportExcel').addEventListener('click', exportarReporteExcel);
            
            // Botones de exportación
            document.getElementById('exportPdf').addEventListener('click', exportarPDF);
            document.getElementById('exportExcel').addEventListener('click', exportarExcel);
            document.getElementById('exportInventoryExcel').addEventListener('click', exportarInventarioActualExcel);
            
            // Botón de sincronización
            document.getElementById('syncData').addEventListener('click', syncData);
            
            // Modal - cerrar
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', cerrarModal);
            });
            
            // Confirmar eliminación de producto
            document.getElementById('confirmDelete').addEventListener('click', eliminarProducto);
            document.getElementById('cancelDelete').addEventListener('click', cerrarModal);
            
            // Confirmar eliminación de movimiento
            document.getElementById('confirmMovDelete').addEventListener('click', eliminarMovimiento);
            document.getElementById('cancelMovDelete').addEventListener('click', cerrarModal);
            
            // Formulario de edición de movimiento
            document.getElementById('editMovForm').addEventListener('submit', function(e) {
                e.preventDefault();
                guardarCambiosMovimiento();
            });
            
            // Cerrar modal al hacer clic fuera
            window.addEventListener('click', function(event) {
                const modals = ['editModal', 'confirmModal', 'adjustModal', 'editMovModal', 'confirmMovModal'];
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (event.target === modal) {
                        cerrarModal();
                    }
                });
            });
        }

        // Función para guardar producto (con Firebase)
        async function guardarProducto(e) {
            e.preventDefault();
            
            // Obtener valores del formulario
            const codigo = document.getElementById('codigoProducto').value.trim();
            const nombre = document.getElementById('nombreProducto').value.trim();
            const categoria = document.getElementById('categoriaProducto').value;
            const unidad = document.getElementById('unidadProducto').value;
            const unidadesPorMedida = parseInt(document.getElementById('unidadesPorMedida').value);
            const stockInicial = parseInt(document.getElementById('stockInicial').value);
            const stockMinimo = parseInt(document.getElementById('stockMinimo').value);
            const descripcion = document.getElementById('descripcionProducto').value.trim();
            
            // Validaciones
            if (!codigo || !nombre || !categoria || !unidad || isNaN(unidadesPorMedida) || isNaN(stockInicial) || isNaN(stockMinimo)) {
                alert('Por favor complete todos los campos requeridos');
                return;
            }
            
            if (unidadesPorMedida <= 0) {
                alert('Las unidades por medida deben ser mayor a 0');
                return;
            }
            
            // Verificar si el código ya existe
            const codigoExiste = productos.some(p => p.codigo === codigo);
            if (codigoExiste) {
                alert('Ya existe un producto con este código. Use la función de reposición.');
                return;
            }
            
            // Crear nuevo producto
            const nuevoProducto = {
                id: nextProductId,
                codigo: codigo,
                nombre: nombre,
                categoria: categoria,
                stock: stockInicial,
                stockMinimo: stockMinimo,
                unidad: unidad,
                unidadesPorMedida: unidadesPorMedida,
                descripcion: descripcion,
                fechaRegistro: new Date().toISOString().split('T')[0],
                createdAt: new Date().toISOString()
            };
            
            try {
                // Guardar en Firebase
                const firebaseId = await saveProductToFirebase(nuevoProducto);
                
                if (firebaseId) {
                    // Agregar a la lista local
                    productos.push({...nuevoProducto, firebaseId});
                    nextProductId++;
                    
                    // Registrar movimiento de entrada
                    const unidadesTotales = calcularUnidadesTotales(nuevoProducto);
                    const nuevoMovimiento = {
                        id: nextMovimientoId++,
                        fechaHora: formatearFechaHora(),
                        tipo: "entrada",
                        productoId: nuevoProducto.id,
                        producto: nuevoProducto.nombre,
                        cantidad: unidadesTotales,
                        departamento: "Almacén",
                        usuario: "N/A",
                        observaciones: "Registro inicial de producto: " + (descripcion || "Sin observaciones"),
                        responsable: "Admin Sistema",
                        createdAt: new Date().toISOString()
                    };
                    
                    // Guardar movimiento en Firebase
                    await saveMovementToFirebase(nuevoMovimiento);
                    
                    alert('Producto registrado exitosamente en Firebase');
                    
                    // Limpiar formulario
                    document.getElementById('nuevoProductoForm').reset();
                    document.getElementById('stockMinimo').value = "5";
                    document.getElementById('unidadesPorMedida').value = "1";
                    
                    // Mostrar botón de guardar
                    document.getElementById('saveProductBtn').style.display = 'block';
                    document.getElementById('repositionBtn').style.display = 'none';
                }
            } catch (error) {
                console.error("Error guardando producto:", error);
                alert('Error al guardar el producto en Firebase');
            }
        }

        // Función para guardar reposición (con Firebase)
        async function guardarReposicion() {
            const codigo = document.getElementById('codigoProducto').value.trim();
            const cantidad = parseInt(document.getElementById('stockInicial').value);
            const motivo = document.getElementById('descripcionProducto').value.trim();
            
            if (!codigo || isNaN(cantidad) || cantidad <= 0) {
                alert('Por favor complete todos los campos requeridos');
                return;
            }
            
            const producto = productos.find(p => p.codigo === codigo);
            if (!producto) {
                alert('Producto no encontrado');
                return;
            }
            
            if (!producto.unidadesPorMedida || producto.unidadesPorMedida <= 0) {
                alert('Error: El producto tiene una configuración de unidades inválida. Por favor edite el producto primero.');
                return;
            }
            
            const unidadesAAgregar = cantidad * producto.unidadesPorMedida;
            
            // Actualizar stock localmente
            const nuevoStock = producto.stock + cantidad;
            
            try {
                // Actualizar en Firebase
                const updated = await updateProductInFirebase(producto.firebaseId, {
                    stock: nuevoStock,
                    updatedAt: new Date().toISOString()
                });
                
                if (updated) {
                    // Registrar movimiento de reposición
                    const nuevoMovimiento = {
                        id: nextMovimientoId++,
                        fechaHora: formatearFechaHora(),
                        tipo: "reposicion",
                        productoId: producto.id,
                        producto: producto.nombre,
                        cantidad: unidadesAAgregar,
                        departamento: "Almacén",
                        usuario: "N/A",
                        observaciones: motivo || `Reposición de ${cantidad} ${producto.unidad}`,
                        responsable: "Admin Sistema",
                        createdAt: new Date().toISOString()
                    };
                    
                    // Guardar movimiento en Firebase
                    await saveMovementToFirebase(nuevoMovimiento);
                    
                    alert(`Reposición registrada exitosamente en Firebase. Se agregaron ${unidadesAAgregar} unidades.`);
                    
                    // Limpiar formulario
                    document.getElementById('nuevoProductoForm').reset();
                    document.getElementById('saveProductBtn').style.display = 'block';
                    document.getElementById('repositionBtn').style.display = 'none';
                    document.getElementById('stockMinimo').value = "5";
                    document.getElementById('unidadesPorMedida').value = "1";
                }
            } catch (error) {
                console.error("Error guardando reposición:", error);
                alert('Error al guardar la reposición en Firebase');
            }
        }

        // Función para registrar asignación (con Firebase)
        async function registrarAsignacion(e) {
            e.preventDefault();
            
            // Obtener valores del formulario
            const productoId = document.getElementById('productoAsignar').value;
            const cantidadUnidades = parseInt(document.getElementById('cantidadAsignarUnidades').value);
            const departamento = document.getElementById('departamentoAsignar').value;
            const usuario = document.getElementById('usuarioAsignar').value.trim();
            const fechaHora = document.getElementById('fechaAsignacion').value;
            const observaciones = document.getElementById('observacionesAsignacion').value.trim();
            
            // Validaciones
            if (!productoId || !cantidadUnidades || !departamento || !usuario || !fechaHora) {
                alert('Por favor complete todos los campos requeridos');
                return;
            }
            
            // Buscar producto
            const producto = productos.find(p => p.id == productoId);
            if (!producto) {
                alert('Producto no encontrado');
                return;
            }
            
            const unidadesTotalesActuales = calcularUnidadesTotales(producto);
            
            // Verificar stock disponible
            if (cantidadUnidades > unidadesTotalesActuales) {
                alert(`Stock insuficiente. Disponible: ${unidadesTotalesActuales} unidades`);
                return;
            }
            
            // Calcular nuevo stock en unidades
            const nuevasUnidadesTotales = unidadesTotalesActuales - cantidadUnidades;
            const nuevoStock = calcularStockDesdeUnidades(producto, nuevasUnidadesTotales);
            
            try {
                // Actualizar producto en Firebase
                const updated = await updateProductInFirebase(producto.firebaseId, {
                    stock: nuevoStock,
                    updatedAt: new Date().toISOString()
                });
                
                if (updated) {
                    // Formatear fecha y hora
                    const fechaHoraFormateada = formatearFechaHora(fechaHora);
                    
                    // Registrar movimiento en Firebase
                    const nuevoMovimiento = {
                        id: nextMovimientoId++,
                        fechaHora: fechaHoraFormateada,
                        tipo: "salida",
                        productoId: producto.id,
                        producto: producto.nombre,
                        cantidad: cantidadUnidades,
                        departamento: departamento,
                        usuario: usuario,
                        observaciones: observaciones || "Asignación de material",
                        responsable: "Admin Sistema",
                        createdAt: new Date().toISOString()
                    };
                    
                    await saveMovementToFirebase(nuevoMovimiento);
                    
                    alert(`Asignación registrada exitosamente en Firebase. Se asignaron ${cantidadUnidades} unidades.`);
                    
                    // Limpiar formulario
                    document.getElementById('asignacionForm').reset();
                    
                    // Establecer fecha y hora actual
                    const ahora = new Date();
                    ahora.setMinutes(ahora.getMinutes() - ahora.getTimezoneOffset());
                    document.getElementById('fechaAsignacion').value = ahora.toISOString().slice(0, 16);
                    
                    // Limpiar stock disponible y cálculos
                    document.getElementById('stockDisponible').value = '';
                    document.getElementById('equivalenciaUnidades').textContent = '0 unidades';
                    document.getElementById('nuevoStockUnidades').textContent = '0 unidades';
                }
            } catch (error) {
                console.error("Error registrando asignación:", error);
                alert('Error al registrar la asignación en Firebase');
            }
        }

        // Función para eliminar producto (con Firebase) - CORREGIDA
        async function eliminarProducto() {
            const producto = productos.find(p => p.id === currentEditId);
            
            if (!producto) {
                cerrarModal();
                return;
            }
            
            try {
                // Primero eliminar todos los movimientos asociados al producto
                await deleteMovementsByProductId(producto.id);
                
                // Luego eliminar el producto
                const deleted = await deleteProductFromFirebase(producto.firebaseId);
                
                if (deleted) {
                    alert('Producto y sus movimientos asociados eliminados exitosamente de Firebase');
                }
            } catch (error) {
                console.error("Error eliminando producto:", error);
                alert('Error al eliminar el producto de Firebase');
            }
            
            cerrarModal();
        }

        // Función para eliminar movimiento (con Firebase)
        async function eliminarMovimiento() {
            const movimiento = movimientos.find(m => m.id === currentMovEditId);
            
            if (!movimiento) {
                cerrarModal();
                return;
            }
            
            // Revertir el efecto del movimiento en el stock
            const producto = productos.find(p => p.id === movimiento.productoId);
            
            if (producto) {
                const unidadesTotalesActuales = calcularUnidadesTotales(producto);
                
                let nuevasUnidadesTotales = unidadesTotalesActuales;
                
                if (movimiento.tipo === 'entrada' || movimiento.tipo === 'reposicion') {
                    nuevasUnidadesTotales = unidadesTotalesActuales - movimiento.cantidad;
                } else if (movimiento.tipo === 'salida') {
                    nuevasUnidadesTotales = unidadesTotalesActuales + movimiento.cantidad;
                }
                
                const nuevoStock = calcularStockDesdeUnidades(producto, nuevasUnidadesTotales);
                
                try {
                    // Actualizar producto en Firebase
                    await updateProductInFirebase(producto.firebaseId, {
                        stock: nuevoStock,
                        updatedAt: new Date().toISOString()
                    });
                    
                    // Eliminar movimiento de Firebase
                    await deleteMovementFromFirebase(movimiento.firebaseId);
                    
                    alert('Movimiento eliminado exitosamente de Firebase');
                } catch (error) {
                    console.error("Error eliminando movimiento:", error);
                    alert('Error al eliminar el movimiento de Firebase');
                }
            } else {
                // Si el producto ya no existe, solo eliminar el movimiento
                try {
                    await deleteMovementFromFirebase(movimiento.firebaseId);
                    alert('Movimiento eliminado exitosamente de Firebase');
                } catch (error) {
                    console.error("Error eliminando movimiento:", error);
                    alert('Error al eliminar el movimiento de Firebase');
                }
            }
            
            cerrarModal();
        }

        // Función para guardar cambios en movimiento (con Firebase)
        async function guardarCambiosMovimiento() {
            const movimiento = movimientos.find(m => m.id === currentMovEditId);
            
            if (!movimiento) {
                cerrarModal();
                return;
            }
            
            // Obtener valores del formulario
            const departamento = document.getElementById('editMovDepartamento').value.trim();
            const usuario = document.getElementById('editMovUsuario').value.trim();
            const observaciones = document.getElementById('editMovObservaciones').value.trim();
            
            // Validaciones
            if (!departamento || !usuario) {
                alert('Por favor complete los campos requeridos');
                return;
            }
            
            try {
                // Actualizar en Firebase
                const updated = await updateMovementInFirebase(movimiento.firebaseId, {
                    departamento: departamento,
                    usuario: usuario,
                    observaciones: observaciones,
                    updatedAt: new Date().toISOString()
                });
                
                if (updated) {
                    alert('Movimiento actualizado exitosamente en Firebase');
                    cerrarModal();
                }
            } catch (error) {
                console.error("Error actualizando movimiento:", error);
                alert('Error al actualizar el movimiento en Firebase');
            }
        }

        // =============================================
        // FUNCIONES DE UI
        // =============================================

        function mostrarSeccion(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            const seccion = document.getElementById(sectionId);
            if (seccion) {
                seccion.classList.add('active');
            }
            
            document.querySelectorAll('.menu-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-section') === sectionId) {
                    btn.classList.add('active');
                }
            });
        }

        function actualizarFechaHora() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            
            const dateTimeElement = document.getElementById('currentDateTime');
            if (dateTimeElement) {
                dateTimeElement.textContent = now.toLocaleDateString('es-ES', options);
            }
        }

        function verificarCodigoExistente() {
            const codigo = document.getElementById('codigoProducto').value.trim();
            const saveBtn = document.getElementById('saveProductBtn');
            const repositionBtn = document.getElementById('repositionBtn');
            
            if (codigo) {
                const productoExistente = productos.find(p => p.codigo === codigo);
                if (productoExistente) {
                    document.getElementById('nombreProducto').value = productoExistente.nombre;
                    document.getElementById('categoriaProducto').value = productoExistente.categoria;
                    document.getElementById('unidadProducto').value = productoExistente.unidad;
                    document.getElementById('unidadesPorMedida').value = productoExistente.unidadesPorMedida || 1;
                    document.getElementById('stockMinimo').value = productoExistente.stockMinimo;
                    document.getElementById('descripcionProducto').value = `Reposición de stock para ${productoExistente.nombre}`;
                    
                    saveBtn.style.display = 'none';
                    repositionBtn.style.display = 'block';
                } else {
                    saveBtn.style.display = 'block';
                    repositionBtn.style.display = 'none';
                }
            }
        }

        function calcularEquivalenciaAsignacion() {
            const productoId = document.getElementById('productoAsignar').value;
            const cantidadInput = document.getElementById('cantidadAsignarUnidades');
            
            if (!productoId || !cantidadInput) return;
            
            const producto = productos.find(p => p.id == productoId);
            if (!producto) return;
            
            const cantidadUnidades = parseInt(cantidadInput.value) || 0;
            const unidadesTotalesActuales = calcularUnidadesTotales(producto);
            
            let equivalencia = '';
            if (producto.unidad === "UND") {
                equivalencia = `${cantidadUnidades} unidades`;
            } else {
                const equivalenciaMedida = cantidadUnidades / (producto.unidadesPorMedida || 1);
                equivalencia = `${equivalenciaMedida.toFixed(2)} ${producto.unidad} (${cantidadUnidades} unidades)`;
            }
            
            document.getElementById('equivalenciaUnidades').textContent = equivalencia;
            
            if (cantidadUnidades > 0) {
                const nuevoStockUnidades = unidadesTotalesActuales - cantidadUnidades;
                let nuevoStockMedida = '';
                
                if (producto.unidad === "UND") {
                    nuevoStockMedida = `${nuevoStockUnidades} unidades`;
                } else {
                    const nuevoStock = calcularStockDesdeUnidades(producto, nuevoStockUnidades);
                    nuevoStockMedida = `${nuevoStock.toFixed(2)} ${producto.unidad} (${nuevoStockUnidades} unidades)`;
                }
                
                document.getElementById('nuevoStockUnidades').textContent = nuevoStockMedida;
            } else {
                document.getElementById('nuevoStockUnidades').textContent = `${unidadesTotalesActuales} unidades`;
            }
        }

        function generarOpcionesFechaReporte() {
            const monthSelect = document.getElementById('reportMonth');
            const yearSelect = document.getElementById('reportYear');
            
            if (!monthSelect || !yearSelect) return;
            
            const meses = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            
            const currentDate = new Date();
            
            monthSelect.innerHTML = '';
            meses.forEach((mes, index) => {
                const option = document.createElement('option');
                option.value = index + 1;
                option.textContent = mes;
                if (index + 1 === currentDate.getMonth() + 1) {
                    option.selected = true;
                }
                monthSelect.appendChild(option);
            });
            
            yearSelect.innerHTML = '';
            const currentYearNow = currentDate.getFullYear();
            const startYear = 2023;
            const endYear = currentYearNow + 1;
            
            for (let year = startYear; year <= endYear; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYearNow) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
        }

        function cargarProductosAsignacion() {
            const select = document.getElementById('productoAsignar');
            if (!select) return;
            
            select.innerHTML = '<option value="">Seleccione...</option>';
            
            productos.forEach(producto => {
                const unidadesTotales = calcularUnidadesTotales(producto);
                if (unidadesTotales > 0) {
                    const option = document.createElement('option');
                    option.value = producto.id;
                    option.textContent = `${producto.nombre} (${unidadesTotales} unidades)`;
                    select.appendChild(option);
                }
            });
        }

        function cargarDepartamentosFiltros() {
            const filterDept = document.getElementById('filterMovDept');
            
            if (!filterDept) return;
            
            filterDept.innerHTML = '<option value="">Todos los Departamentos</option>';
            
            departamentos.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                filterDept.appendChild(option);
            });
        }

        function actualizarTablaInventario() {
            const tableBody = document.getElementById('inventarioTableBody');
            if (!tableBody) return;
            
            const searchProduct = document.getElementById('searchProduct') ? document.getElementById('searchProduct').value.toLowerCase() : '';
            const filterCategory = document.getElementById('filterCategory') ? document.getElementById('filterCategory').value : '';
            const filterStock = document.getElementById('filterStock') ? document.getElementById('filterStock').value : '';
            
            let productosFiltrados = productos.filter(producto => {
                const searchMatch = searchProduct === '' || 
                    producto.nombre.toLowerCase().includes(searchProduct) ||
                    producto.codigo.toLowerCase().includes(searchProduct);
                
                const categoryMatch = filterCategory === '' || producto.categoria === filterCategory;
                
                let stockMatch = true;
                const unidadesTotales = calcularUnidadesTotales(producto);
                const stockMinimoUnidades = producto.stockMinimo * (producto.unidadesPorMedida || 1);
                
                if (filterStock === 'low') {
                    stockMatch = unidadesTotales < stockMinimoUnidades;
                } else if (filterStock === 'normal') {
                    stockMatch = unidadesTotales >= stockMinimoUnidades && unidadesTotales <= stockMinimoUnidades * 2;
                } else if (filterStock === 'alto') {
                    stockMatch = unidadesTotales > stockMinimoUnidades * 2;
                }
                
                return searchMatch && categoryMatch && stockMatch;
            });
            
            productosFiltrados.sort((a, b) => {
                if (a.categoria === b.categoria) {
                    return a.nombre.localeCompare(b.nombre);
                }
                return a.categoria.localeCompare(b.categoria);
            });
            
            tableBody.innerHTML = '';
            
            if (productosFiltrados.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">No hay productos que coincidan con los filtros</td></tr>';
                return;
            }
            
            productosFiltrados.forEach(producto => {
                const row = document.createElement('tr');
                
                const codigoNum = producto.codigo.split('-')[1] || producto.id;
                const unidadesTotales = calcularUnidadesTotales(producto);
                const stockMinimoUnidades = producto.stockMinimo * (producto.unidadesPorMedida || 1);
                
                let estadoClase = '';
                let estadoTexto = '';
                let stockIndicator = '';
                
                if (unidadesTotales < stockMinimoUnidades) {
                    estadoClase = 'stock-low';
                    estadoTexto = 'Stock Bajo';
                    stockIndicator = '<span class="stock-indicator stock-low"></span>';
                } else if (unidadesTotales < stockMinimoUnidades * 2) {
                    estadoClase = 'stock-medium';
                    estadoTexto = 'Stock Normal';
                    stockIndicator = '<span class="stock-indicator stock-medium"></span>';
                } else {
                    estadoClase = 'stock-high';
                    estadoTexto = 'Stock Alto';
                    stockIndicator = '<span class="stock-indicator stock-high"></span>';
                }
                
                let categoriaNombre = '';
                let categoriaClase = '';
                switch(producto.categoria) {
                    case 'papeleria':
                        categoriaNombre = 'Papelería';
                        categoriaClase = 'badge-papeleria';
                        break;
                    case 'toner':
                        categoriaNombre = 'Toner';
                        categoriaClase = 'badge-toner';
                        break;
                    case 'oficina':
                        categoriaNombre = 'Oficina';
                        categoriaClase = 'badge-oficina';
                        break;
                    case 'electronica':
                        categoriaNombre = 'Electrónica';
                        categoriaClase = 'badge-electronica';
                        break;
                    case 'limpieza':
                        categoriaNombre = 'Limpieza';
                        categoriaClase = 'badge-otros';
                        break;
                    case 'otros':
                        categoriaNombre = 'Otros';
                        categoriaClase = 'badge-otros';
                        break;
                    default:
                        categoriaNombre = producto.categoria;
                        categoriaClase = 'badge-otros';
                }
                
                let infoUnidades = '';
                if (producto.unidad === "UND") {
                    infoUnidades = `${producto.stock} ${producto.unidad}`;
                } else {
                    infoUnidades = `${producto.stock} ${producto.unidad}`;
                }
                
                let infoStockMinimo = '';
                if (producto.unidad === "UND") {
                    infoStockMinimo = `${producto.stockMinimo} ${producto.unidad}`;
                } else {
                    infoStockMinimo = `${producto.stockMinimo} ${producto.unidad} (${stockMinimoUnidades} unidades)`;
                }
                
                row.innerHTML = `
                    <td><strong>${codigoNum}</strong></td>
                    <td>
                        <div>${producto.nombre}</div>
                        <div class="unit-info">Código: ${producto.codigo}</div>
                    </td>
                    <td><span class="badge ${categoriaClase}">${categoriaNombre}</span></td>
                    <td>
                        <div class="stock-details">
                            <span class="stock-total">${infoUnidades}</span>
                            <span class="unit-info">${unidadesTotales} unidades totales</span>
                        </div>
                    </td>
                    <td>${unidadesTotales} unidades</td>
                    <td>${producto.unidad}</td>
                    <td>${infoStockMinimo}</td>
                    <td class="${estadoClase}">${stockIndicator} ${estadoTexto}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-edit" data-id="${producto.id}">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn-action btn-assign" data-id="${producto.id}">
                                <i class="fas fa-hand-holding"></i> Asignar
                            </button>
                            <button class="btn-action btn-adjust" data-id="${producto.id}">
                                <i class="fas fa-adjust"></i> Ajustar
                            </button>
                            <button class="btn-action btn-reposition" data-id="${producto.id}">
                                <i class="fas fa-boxes"></i> Reponer
                            </button>
                            <button class="btn-action btn-delete" data-id="${producto.id}">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    editarProducto(id);
                });
            });
            
            document.querySelectorAll('.btn-assign').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    irAAsignacion(id);
                });
            });
            
            document.querySelectorAll('.btn-adjust').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    ajustarStock(id);
                });
            });
            
            document.querySelectorAll('.btn-reposition').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    irAReposicion(id);
                });
            });
            
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    confirmarEliminacion(id);
                });
            });
            
            const totalProductsElement = document.getElementById('totalProducts');
            if (totalProductsElement) {
                totalProductsElement.textContent = productos.length;
            }
        }

        function irAReposicion(productoId) {
            const producto = productos.find(p => p.id === productoId);
            if (!producto) return;
            
            mostrarSeccion('nuevo-producto');
            
            document.getElementById('codigoProducto').value = producto.codigo;
            document.getElementById('nombreProducto').value = producto.nombre;
            document.getElementById('categoriaProducto').value = producto.categoria;
            document.getElementById('unidadProducto').value = producto.unidad;
            document.getElementById('unidadesPorMedida').value = producto.unidadesPorMedida || 1;
            document.getElementById('stockMinimo').value = producto.stockMinimo;
            document.getElementById('descripcionProducto').value = `Reposición de stock para ${producto.nombre}`;
            
            document.getElementById('saveProductBtn').style.display = 'none';
            document.getElementById('repositionBtn').style.display = 'block';
        }

        function actualizarTablaMovimientos() {
            const tableBody = document.getElementById('movimientosTableBody');
            if (!tableBody) return;
            
            const filterMovimiento = document.getElementById('filterMovimiento') ? document.getElementById('filterMovimiento').value : '';
            const filterDept = document.getElementById('filterMovDept') ? document.getElementById('filterMovDept').value : '';
            const filterFecha = document.getElementById('filterMovFecha') ? document.getElementById('filterMovFecha').value : '';
            
            let movimientosFiltrados = movimientos.filter(movimiento => {
                const tipoMatch = filterMovimiento === '' || movimiento.tipo === filterMovimiento;
                const deptMatch = filterDept === '' || movimiento.departamento === filterDept;
                const fechaMatch = filterFecha === '' || movimiento.fechaHora.startsWith(filterFecha);
                
                return tipoMatch && deptMatch && fechaMatch;
            });
            
            movimientosFiltrados.sort((a, b) => new Date(b.fechaHora) - new Date(a.fechaHora));
            
            tableBody.innerHTML = '';
            
            if (movimientosFiltrados.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">No hay movimientos que coincidan con los filtros</td></tr>';
                return;
            }
            
            movimientosFiltrados.forEach(movimiento => {
                const row = document.createElement('tr');
                
                let tipoTexto = '';
                let tipoColor = '';
                
                switch(movimiento.tipo) {
                    case 'entrada':
                        tipoTexto = 'Entrada';
                        tipoColor = '#27ae60';
                        break;
                    case 'salida':
                        tipoTexto = 'Salida';
                        tipoColor = '#e74c3c';
                        break;
                    case 'ajuste':
                        tipoTexto = 'Ajuste';
                        tipoColor = '#f39c12';
                        break;
                    case 'reposicion':
                        tipoTexto = 'Reposición';
                        tipoColor = '#9b59b6';
                        break;
                    default:
                        tipoTexto = movimiento.tipo;
                }
                
                row.innerHTML = `
                    <td>${movimiento.fechaHora}</td>
                    <td><span style="color: ${tipoColor}; font-weight: 600;">${tipoTexto}</span></td>
                    <td>${movimiento.producto}</td>
                    <td>${movimiento.cantidad} unidades</td>
                    <td>${movimiento.departamento}</td>
                    <td>${movimiento.usuario}</td>
                    <td>${movimiento.observaciones || '-'}</td>
                    <td>${movimiento.responsable}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-edit-mov" data-id="${movimiento.id}">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn-action btn-delete-mov" data-id="${movimiento.id}">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            document.querySelectorAll('.btn-edit-mov').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    editarMovimiento(id);
                });
            });
            
            document.querySelectorAll('.btn-delete-mov').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    confirmarEliminacionMovimiento(id);
                });
            });
        }

        function actualizarEstadisticas() {
            let lowStockCount = 0;
            let totalUnidades = 0;
            
            productos.forEach(producto => {
                const unidadesTotales = calcularUnidadesTotales(producto);
                const stockMinimoUnidades = producto.stockMinimo * (producto.unidadesPorMedida || 1);
                totalUnidades += unidadesTotales;
                
                if (unidadesTotales < stockMinimoUnidades) {
                    lowStockCount++;
                }
            });
            
            const lowStockElement = document.getElementById('lowStockCount');
            if (lowStockElement) {
                lowStockElement.textContent = lowStockCount;
            }
            
            const hoy = new Date().toISOString().split('T')[0];
            const todayAssignments = movimientos.filter(m => 
                m.fechaHora.startsWith(hoy) && m.tipo === 'salida'
            ).length;
            
            const todayAssignmentsElement = document.getElementById('todayAssignments');
            if (todayAssignmentsElement) {
                todayAssignmentsElement.textContent = todayAssignments;
            }
            
            const totalStockElement = document.getElementById('totalStock');
            if (totalStockElement) {
                totalStockElement.textContent = totalUnidades.toLocaleString();
            }
        }

        function actualizarDashboard() {
            let totalUnidades = 0;
            let lowStockCount = 0;
            
            productos.forEach(producto => {
                const unidadesTotales = calcularUnidadesTotales(producto);
                const stockMinimoUnidades = producto.stockMinimo * (producto.unidadesPorMedida || 1);
                totalUnidades += unidadesTotales;
                
                if (unidadesTotales < stockMinimoUnidades) {
                    lowStockCount++;
                }
            });
            
            document.getElementById('dashboardTotalProducts').textContent = productos.length;
            document.getElementById('dashboardLowStock').textContent = lowStockCount;
            document.getElementById('dashboardTotalUnits').textContent = totalUnidades.toLocaleString();
            
            const hoy = new Date();
            const mesActual = hoy.getMonth() + 1;
            const añoActual = hoy.getFullYear();
            
            const asignacionesEsteMes = movimientos.filter(m => {
                const fechaMov = new Date(m.fechaHora);
                return m.tipo === 'salida' && 
                       fechaMov.getMonth() + 1 === mesActual && 
                       fechaMov.getFullYear() === añoActual;
            }).length;
            
            document.getElementById('dashboardTotalAssignments').textContent = asignacionesEsteMes;
            
            actualizarGraficoCategorias();
            actualizarListaStockBajo();
        }

        function actualizarGraficoCategorias() {
            if (categoryChartInstance) {
                categoryChartInstance.destroy();
            }
            
            const categorias = {
                papeleria: 0,
                oficina: 0,
                toner: 0,
                electronica: 0,
                limpieza: 0,
                otros: 0
            };
            
            productos.forEach(producto => {
                const unidadesTotales = calcularUnidadesTotales(producto);
                if (categorias.hasOwnProperty(producto.categoria)) {
                    categorias[producto.categoria] += unidadesTotales;
                }
            });
            
            const categoryChartCanvas = document.getElementById('categoryChart');
            if (categoryChartCanvas) {
                const ctx = categoryChartCanvas.getContext('2d');
                
                categoryChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Papelería', 'Oficina', 'Toner', 'Electrónica', 'Limpieza', 'Otros'],
                        datasets: [{
                            label: 'Unidades por Categoría',
                            data: [
                                categorias.papeleria,
                                categorias.oficina,
                                categorias.toner,
                                categorias.electronica,
                                categorias.limpieza,
                                categorias.otros
                            ],
                            backgroundColor: [
                                '#3498db',
                                '#f39c12',
                                '#27ae60',
                                '#9b59b6',
                                '#e74c3c',
                                '#95a5a6'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.raw.toLocaleString()} unidades`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function actualizarListaStockBajo() {
            const container = document.getElementById('lowStockList');
            if (!container) return;
            
            const productosBajos = productos.filter(producto => {
                const unidadesTotales = calcularUnidadesTotales(producto);
                const stockMinimoUnidades = producto.stockMinimo * (producto.unidadesPorMedida || 1);
                return unidadesTotales < stockMinimoUnidades;
            });
            
            if (productosBajos.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay productos con stock bajo</p>';
                return;
            }
            
            let html = '<div style="max-height: 200px; overflow-y: auto;">';
            
            productosBajos.forEach(producto => {
                const unidadesTotales = calcularUnidadesTotales(producto);
                const stockMinimoUnidades = producto.stockMinimo * (producto.unidadesPorMedida || 1);
                const porcentaje = Math.round((unidadesTotales / stockMinimoUnidades) * 100);
                
                html += `
                    <div class="product-card low-stock">
                        <div class="product-card-header">
                            <div class="product-name">${producto.nombre}</div>
                            <div class="product-category">${producto.codigo}</div>
                        </div>
                        <div class="product-stock">
                            Stock: ${unidadesTotales} unidades (Mínimo: ${stockMinimoUnidades} unidades)
                        </div>
                        <div class="stock-progress">
                            <div class="stock-progress-bar low" style="width: ${porcentaje > 100 ? 100 : porcentaje}%"></div>
                        </div>
                        <div style="font-size: 0.8rem; color: #e74c3c;">
                            <i class="fas fa-exclamation-triangle"></i> 
                            Stock ${porcentaje}% del mínimo requerido
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function verificarStockBajo() {
            let lowStockCount = 0;
            
            productos.forEach(producto => {
                const unidadesTotales = calcularUnidadesTotales(producto);
                const stockMinimoUnidades = producto.stockMinimo * (producto.unidadesPorMedida || 1);
                
                if (unidadesTotales < stockMinimoUnidades) {
                    lowStockCount++;
                }
            });
            
            const alertElement = document.getElementById('stockAlert');
            const alertMessage = document.getElementById('alertMessage');
            
            if (lowStockCount > 0) {
                alertElement.classList.add('show');
                alertMessage.textContent = `Hay ${lowStockCount} producto(s) con stock bajo. Verifique el inventario.`;
                
                const lowStockCard = document.getElementById('lowStockCard');
                if (lowStockCard) {
                    lowStockCard.classList.remove('warning');
                    lowStockCard.classList.add('danger');
                }
            } else {
                alertElement.classList.remove('show');
                
                const lowStockCard = document.getElementById('lowStockCard');
                if (lowStockCard) {
                    lowStockCard.classList.remove('danger');
                    lowStockCard.classList.add('warning');
                }
            }
        }

        function irAAsignacion(productoId) {
            mostrarSeccion('asignacion');
            
            const selectProducto = document.getElementById('productoAsignar');
            if (selectProducto) {
                selectProducto.value = productoId;
                
                const event = new Event('change');
                selectProducto.dispatchEvent(event);
            }
        }

        function ajustarStock(productoId) {
            currentAdjustId = productoId;
            const producto = productos.find(p => p.id === productoId);
            
            if (!producto) return;
            
            const unidadesTotales = calcularUnidadesTotales(producto);
            
            document.getElementById('adjustProductName').value = producto.nombre;
            document.getElementById('adjustCurrentStock').value = `${unidadesTotales} unidades`;
            document.getElementById('adjustCurrentStockMedida').value = `${producto.stock} ${producto.unidad}`;
            
            document.getElementById('adjustModal').style.display = 'flex';
            
            const adjustForm = document.getElementById('adjustStockForm');
            if (adjustForm) {
                adjustForm.onsubmit = function(e) {
                    e.preventDefault();
                    aplicarAjusteStock();
                };
            }
        }

        async function aplicarAjusteStock() {
            const producto = productos.find(p => p.id === currentAdjustId);
            
            if (!producto) return;
            
            const tipo = document.getElementById('adjustType').value;
            const cantidad = parseInt(document.getElementById('adjustQuantity').value);
            const motivo = document.getElementById('adjustReason').value.trim();
            
            if (!cantidad || !motivo) {
                alert('Por favor complete todos los campos');
                return;
            }
            
            const unidadesTotalesActuales = calcularUnidadesTotales(producto);
            let nuevasUnidadesTotales = unidadesTotalesActuales;
            
            if (tipo === 'entrada' || tipo === 'reposicion') {
                nuevasUnidadesTotales = unidadesTotalesActuales + cantidad;
            } else {
                if (cantidad > unidadesTotalesActuales) {
                    alert(`Cantidad excede el stock disponible. Disponible: ${unidadesTotalesActuales} unidades`);
                    return;
                }
                nuevasUnidadesTotales = unidadesTotalesActuales - cantidad;
            }
            
            const nuevoStock = calcularStockDesdeUnidades(producto, nuevasUnidadesTotales);
            
            try {
                // Actualizar producto en Firebase
                await updateProductInFirebase(producto.firebaseId, {
                    stock: nuevoStock,
                    updatedAt: new Date().toISOString()
                });
                
                // Registrar movimiento en Firebase
                const movimientoTipo = tipo === 'reposicion' ? 'reposicion' : 'ajuste';
                const nuevoMovimiento = {
                    id: nextMovimientoId++,
                    fechaHora: formatearFechaHora(),
                    tipo: movimientoTipo,
                    productoId: producto.id,
                    producto: producto.nombre,
                    cantidad: cantidad,
                    departamento: "Almacén",
                    usuario: "N/A",
                    observaciones: motivo,
                    responsable: "Admin Sistema",
                    createdAt: new Date().toISOString()
                };
                
                await saveMovementToFirebase(nuevoMovimiento);
                
                alert(`Stock ajustado exitosamente en Firebase. Nuevo stock: ${nuevasUnidadesTotales} unidades`);
                cerrarModal();
            } catch (error) {
                console.error("Error aplicando ajuste:", error);
                alert('Error al aplicar el ajuste en Firebase');
            }
        }

        function editarProducto(id) {
            currentEditId = id;
            const producto = productos.find(p => p.id === id);
            
            if (!producto) return;
            
            const modalBody = document.querySelector('#editModal .modal-body');
            if (!modalBody) return;
            
            modalBody.innerHTML = `
                <form id="editForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editCodigo">Código del Producto *</label>
                            <input type="text" id="editCodigo" value="${producto.codigo}" required>
                        </div>
                        <div class="form-group">
                            <label for="editNombre">Nombre del Producto *</label>
                            <input type="text" id="editNombre" value="${producto.nombre}" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editCategoria">Categoría *</label>
                            <select id="editCategoria" required>
                                <option value="papeleria" ${producto.categoria === 'papeleria' ? 'selected' : ''}>Papelería</option>
                                <option value="oficina" ${producto.categoria === 'oficina' ? 'selected' : ''}>Artículos de Oficina</option>
                                <option value="toner" ${producto.categoria === 'toner' ? 'selected' : ''}>Toner</option>
                                <option value="electronica" ${producto.categoria === 'electronica' ? 'selected' : ''}>Electrónica</option>
                                <option value="limpieza" ${producto.categoria === 'limpieza' ? 'selected' : ''}>Limpieza</option>
                                <option value="otros" ${producto.categoria === 'otros' ? 'selected' : ''}>Otros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editUnidad">Unidad de Medida *</label>
                            <select id="editUnidad" required>
                                <option value="UND" ${producto.unidad === 'UND' ? 'selected' : ''}>Unidades</option>
                                <option value="CAJAS" ${producto.unidad === 'CAJAS' ? 'selected' : ''}>Cajas</option>
                                <option value="PAQ" ${producto.unidad === 'PAQ' ? 'selected' : ''}>Paquetes</option>
                                <option value="GALON" ${producto.unidad === 'GALON' ? 'selected' : ''}>Galones</option>
                                <option value="LT" ${producto.unidad === 'LT' ? 'selected' : ''}>Litros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editUnidadesPorMedida">Unidades por Medida *</label>
                            <input type="number" id="editUnidadesPorMedida" min="1" value="${producto.unidadesPorMedida || 1}" required>
                            <small class="unit-conversion">Ej: 24 unidades por caja, 100 unidades por paquete</small>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editStock">Stock Actual *</label>
                            <input type="number" id="editStock" value="${producto.stock}" min="0" step="0.01" required>
                            <small class="unit-conversion">En la unidad de medida seleccionada</small>
                        </div>
                        <div class="form-group">
                            <label for="editStockMinimo">Stock Mínimo *</label>
                            <input type="number" id="editStockMinimo" value="${producto.stockMinimo}" min="1" required>
                            <small class="unit-conversion">En la unidad de medida seleccionada</small>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="editDescripcion">Descripción</label>
                            <textarea id="editDescripcion" rows="3">${producto.descripcion || ''}</textarea>
                        </div>
                    </div>
                    
                    <div class="form-buttons">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Guardar Cambios
                        </button>
                        <button type="button" id="cancelEdit" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </form>
            `;
            
            document.getElementById('editModal').style.display = 'flex';
            
            const editForm = document.getElementById('editForm');
            if (editForm) {
                editForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    guardarCambiosEdicion();
                });
            }
            
            const cancelEditBtn = document.getElementById('cancelEdit');
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', cerrarModal);
            }
        }

        async function guardarCambiosEdicion() {
            const producto = productos.find(p => p.id === currentEditId);
            
            if (!producto) return;
            
            const codigo = document.getElementById('editCodigo').value.trim();
            const nombre = document.getElementById('editNombre').value.trim();
            const categoria = document.getElementById('editCategoria').value;
            const unidad = document.getElementById('editUnidad').value;
            const unidadesPorMedida = parseInt(document.getElementById('editUnidadesPorMedida').value);
            const stock = parseFloat(document.getElementById('editStock').value);
            const stockMinimo = parseInt(document.getElementById('editStockMinimo').value);
            const descripcion = document.getElementById('editDescripcion').value.trim();
            
            if (!codigo || !nombre || !categoria || !unidad || isNaN(unidadesPorMedida) || isNaN(stock) || isNaN(stockMinimo)) {
                alert('Por favor complete todos los campos requeridos');
                return;
            }
            
            if (unidadesPorMedida <= 0) {
                alert('Las unidades por medida deben ser mayor a 0');
                return;
            }
            
            const codigoExiste = productos.some(p => p.codigo === codigo && p.id !== currentEditId);
            if (codigoExiste) {
                alert('Ya existe otro producto con este código');
                return;
            }
            
            try {
                // Actualizar en Firebase
                await updateProductInFirebase(producto.firebaseId, {
                    codigo: codigo,
                    nombre: nombre,
                    categoria: categoria,
                    unidad: unidad,
                    unidadesPorMedida: unidadesPorMedida,
                    stock: stock,
                    stockMinimo: stockMinimo,
                    descripcion: descripcion,
                    updatedAt: new Date().toISOString()
                });
                
                alert('Producto actualizado exitosamente en Firebase');
                cerrarModal();
            } catch (error) {
                console.error("Error actualizando producto:", error);
                alert('Error al actualizar el producto en Firebase');
            }
        }

        function confirmarEliminacion(id) {
            currentEditId = id;
            const confirmModal = document.getElementById('confirmModal');
            if (confirmModal) {
                confirmModal.style.display = 'flex';
            }
        }

        function confirmarEliminacionMovimiento(id) {
            currentMovEditId = id;
            const movimiento = movimientos.find(m => m.id === id);
            
            if (!movimiento) return;
            
            const confirmModal = document.getElementById('confirmMovModal');
            const confirmMessage = document.getElementById('confirmMovMessage');
            
            if (confirmModal && confirmMessage) {
                confirmMessage.textContent = `¿Está seguro de que desea eliminar este movimiento de ${movimiento.tipo} para "${movimiento.producto}"? Esta acción revertirá el stock afectado.`;
                confirmModal.style.display = 'flex';
            }
        }

        function cerrarModal() {
            const modals = ['editModal', 'confirmModal', 'adjustModal', 'editMovModal', 'confirmMovModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) modal.style.display = 'none';
            });
            
            currentEditId = null;
            currentAdjustId = null;
            currentMovEditId = null;
            
            const adjustForm = document.getElementById('adjustStockForm');
            if (adjustForm) adjustForm.reset();
            
            const editMovForm = document.getElementById('editMovForm');
            if (editMovForm) editMovForm.reset();
        }

        function limpiarFiltrosInventario() {
            const searchProduct = document.getElementById('searchProduct');
            const filterCategory = document.getElementById('filterCategory');
            const filterStock = document.getElementById('filterStock');
            
            if (searchProduct) searchProduct.value = '';
            if (filterCategory) filterCategory.value = '';
            if (filterStock) filterStock.value = '';
            
            actualizarTablaInventario();
        }

        function limpiarFiltrosMovimientos() {
            const filterMovimiento = document.getElementById('filterMovimiento');
            const filterDept = document.getElementById('filterMovDept');
            const filterFecha = document.getElementById('filterMovFecha');
            
            if (filterMovimiento) filterMovimiento.value = '';
            if (filterDept) filterDept.value = '';
            if (filterFecha) filterFecha.value = '';
            
            actualizarTablaMovimientos();
        }

        function editarMovimiento(id) {
            currentMovEditId = id;
            const movimiento = movimientos.find(m => m.id === id);
            
            if (!movimiento) return;
            
            document.getElementById('editMovProducto').value = movimiento.producto;
            document.getElementById('editMovTipo').value = movimiento.tipo;
            document.getElementById('editMovCantidad').value = movimiento.cantidad;
            document.getElementById('editMovDepartamento').value = movimiento.departamento;
            document.getElementById('editMovUsuario').value = movimiento.usuario;
            document.getElementById('editMovObservaciones').value = movimiento.observaciones || '';
            
            document.getElementById('editMovModal').style.display = 'flex';
        }

        function generarReporteMensual() {
            const monthSelect = document.getElementById('reportMonth');
            const yearSelect = document.getElementById('reportYear');
            
            if (!monthSelect || !yearSelect) return;
            
            const month = parseInt(monthSelect.value);
            const year = parseInt(yearSelect.value);
            
            const movimientosMensuales = movimientos.filter(movimiento => {
                const fecha = new Date(movimiento.fechaHora);
                return fecha.getMonth() + 1 === month && fecha.getFullYear() === year;
            });
            
            document.getElementById('chartTitle1').textContent = `Consumo por Departamento - ${monthSelect.options[monthSelect.selectedIndex].text} ${year}`;
            document.getElementById('chartTitle2').textContent = `Top 10 Productos Más Utilizados - ${monthSelect.options[monthSelect.selectedIndex].text} ${year}`;
            
            actualizarGraficosReporte(movimientosMensuales);
            actualizarResumenAsignaciones(movimientosMensuales);
        }

        function generarReporteAnual() {
            const yearSelect = document.getElementById('reportYear');
            if (!yearSelect) return;
            
            const year = parseInt(yearSelect.value);
            
            const movimientosAnuales = movimientos.filter(movimiento => {
                const fecha = new Date(movimiento.fechaHora);
                return fecha.getFullYear() === year;
            });
            
            document.getElementById('chartTitle1').textContent = `Consumo por Departamento - Año ${year}`;
            document.getElementById('chartTitle2').textContent = `Top 10 Productos Más Utilizados - Año ${year}`;
            
            actualizarGraficosReporte(movimientosAnuales);
            actualizarResumenAsignaciones(movimientosAnuales);
        }

        function generarReporteDepartamento() {
            document.getElementById('chartTitle1').textContent = 'Consumo por Departamento (Total)';
            document.getElementById('chartTitle2').textContent = 'Top 10 Productos Más Utilizados (Total)';
            
            actualizarGraficosReporte(movimientos);
            actualizarResumenAsignaciones(movimientos);
        }

        function generarReporteProductos() {
            document.getElementById('chartTitle1').textContent = 'Stock por Categoría (Actual)';
            document.getElementById('chartTitle2').textContent = 'Productos con Menor Stock';
            
            actualizarGraficoProductosBajos();
            actualizarResumenProductos();
        }

        function actualizarGraficoProductosBajos() {
            if (deptChartInstance) {
                deptChartInstance.destroy();
            }
            if (topProductsChartInstance) {
                topProductsChartInstance.destroy();
            }
            
            const productosOrdenados = [...productos].sort((a, b) => {
                const porcentajeA = calcularUnidadesTotales(a) / (a.stockMinimo * (a.unidadesPorMedida || 1));
                const porcentajeB = calcularUnidadesTotales(b) / (b.stockMinimo * (b.unidadesPorMedida || 1));
                return porcentajeA - porcentajeB;
            }).slice(0, 10);
            
            const deptChartCanvas = document.getElementById('deptChart');
            if (deptChartCanvas && productosOrdenados.length > 0) {
                const ctx = deptChartCanvas.getContext('2d');
                
                deptChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: productosOrdenados.map(p => p.nombre),
                        datasets: [{
                            label: 'Porcentaje del Stock Mínimo',
                            data: productosOrdenados.map(p => {
                                const unidades = calcularUnidadesTotales(p);
                                const minimo = p.stockMinimo * (p.unidadesPorMedida || 1);
                                return Math.round((unidades / minimo) * 100);
                            }),
                            backgroundColor: productosOrdenados.map(p => {
                                const unidades = calcularUnidadesTotales(p);
                                const minimo = p.stockMinimo * (p.unidadesPorMedida || 1);
                                return unidades < minimo ? '#e74c3c' : 
                                       unidades < minimo * 2 ? '#f39c12' : '#27ae60';
                            })
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Porcentaje (%)'
                                },
                                max: 200
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const producto = productosOrdenados[context.dataIndex];
                                        const unidades = calcularUnidadesTotales(producto);
                                        const minimo = producto.stockMinimo * (producto.unidadesPorMedida || 1);
                                        return `${producto.nombre}: ${unidades}/${minimo} unidades (${context.raw}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            const topProductsChartCanvas = document.getElementById('topProductsChart');
            if (topProductsChartCanvas) {
                const ctx = topProductsChartCanvas.getContext('2d');
                
                const categorias = {};
                productos.forEach(producto => {
                    if (!categorias[producto.categoria]) {
                        categorias[producto.categoria] = 0;
                    }
                    categorias[producto.categoria]++;
                });
                
                const nombresCategorias = {
                    'papeleria': 'Papelería',
                    'oficina': 'Oficina',
                    'toner': 'Toner',
                    'electronica': 'Electrónica',
                    'limpieza': 'Limpieza',
                    'otros': 'Otros'
                };
                
                topProductsChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(categorias).map(cat => nombresCategorias[cat] || cat),
                        datasets: [{
                            label: 'Productos por Categoría',
                            data: Object.values(categorias),
                            backgroundColor: [
                                '#3498db',
                                '#f39c12',
                                '#27ae60',
                                '#9b59b6',
                                '#e74c3c',
                                '#95a5a6'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.raw} productos`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function actualizarResumenProductos() {
            const container = document.getElementById('resumenAsignaciones');
            if (!container) return;
            
            let totalProductos = productos.length;
            let productosBajos = 0;
            let productosAgotados = 0;
            let totalUnidades = 0;
            
            productos.forEach(producto => {
                const unidades = calcularUnidadesTotales(producto);
                const minimo = producto.stockMinimo * (producto.unidadesPorMedida || 1);
                totalUnidades += unidades;
                
                if (unidades < minimo) productosBajos++;
                if (unidades === 0) productosAgotados++;
            });
            
            let html = `
                <div class="stats-grid">
                    <div class="stat-box">
                        <i class="fas fa-boxes"></i>
                        <div class="stat-content">
                            <h4>Total Productos</h4>
                            <p>${totalProductos}</p>
                        </div>
                    </div>
                    
                    <div class="stat-box">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div class="stat-content">
                            <h4>Productos con Stock Bajo</h4>
                            <p>${productosBajos}</p>
                        </div>
                    </div>
                    
                    <div class="stat-box">
                        <i class="fas fa-times-circle"></i>
                        <div class="stat-content">
                            <h4>Productos Agotados</h4>
                            <p>${productosAgotados}</p>
                        </div>
                    </div>
                    
                    <div class="stat-box">
                        <i class="fas fa-calculator"></i>
                        <div class="stat-content">
                            <h4>Total Unidades</h4>
                            <p>${totalUnidades.toLocaleString()}</p>
                        </div>
                    </div>
                </div>
                
                <h4 style="margin-top: 20px;">Productos que Necesitan Reposición</h4>
                <div style="margin-top: 10px;">
            `;
            
            const productosReponer = productos.filter(p => {
                const unidades = calcularUnidadesTotales(p);
                const minimo = p.stockMinimo * (p.unidadesPorMedida || 1);
                return unidades < minimo;
            }).sort((a, b) => {
                const porcentajeA = calcularUnidadesTotales(a) / (a.stockMinimo * (a.unidadesPorMedida || 1));
                const porcentajeB = calcularUnidadesTotales(b) / (b.stockMinimo * (b.unidadesPorMedida || 1));
                return porcentajeA - porcentajeB;
            });
            
            if (productosReponer.length === 0) {
                html += '<p style="text-align: center; color: #666; padding: 20px;">No hay productos que necesiten reposición</p>';
            } else {
                productosReponer.forEach(producto => {
                    const unidades = calcularUnidadesTotales(producto);
                    const minimo = producto.stockMinimo * (producto.unidadesPorMedida || 1);
                    const porcentaje = Math.round((unidades / minimo) * 100);
                    const faltan = minimo - unidades;
                    
                    html += `
                        <div style="margin-bottom: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px; border-left: 4px solid ${porcentaje < 50 ? '#e74c3c' : '#f39c12'}">
                            <div style="display: flex; justify-content: space-between;">
                                <strong>${producto.nombre}</strong>
                                <span>${unidades}/${minimo} unidades (${porcentaje}%)</span>
                            </div>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                                <div>Código: ${producto.codigo} | Categoría: ${producto.categoria}</div>
                                <div>Faltan: ${faltan} unidades para llegar al mínimo</div>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function actualizarGraficosReporte(movimientosFiltrados) {
            if (deptChartInstance) {
                deptChartInstance.destroy();
            }
            if (topProductsChartInstance) {
                topProductsChartInstance.destroy();
            }
            
            const deptSalidas = {};
            const movimientosSalidas = movimientosFiltrados.filter(m => m.tipo === 'salida');
            
            movimientosSalidas.forEach(movimiento => {
                const dept = movimiento.departamento;
                if (!deptSalidas[dept]) {
                    deptSalidas[dept] = 0;
                }
                deptSalidas[dept] += movimiento.cantidad;
            });
            
            const deptChartCanvas = document.getElementById('deptChart');
            if (deptChartCanvas && Object.keys(deptSalidas).length > 0) {
                const ctx = deptChartCanvas.getContext('2d');
                
                const deptsOrdenados = Object.entries(deptSalidas)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                deptChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: deptsOrdenados.map(d => d[0]),
                        datasets: [{
                            label: 'Unidades Asignadas',
                            data: deptsOrdenados.map(d => d[1]),
                            backgroundColor: '#3498db',
                            borderColor: '#2980b9',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Unidades'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.raw.toLocaleString()} unidades`;
                                    }
                                }
                            }
                        }
                    }
                });
            } else if (deptChartCanvas) {
                deptChartCanvas.parentNode.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay datos de asignaciones para mostrar</p>';
            }
            
            const productoUso = {};
            movimientosSalidas.forEach(movimiento => {
                const producto = movimiento.producto;
                if (!productoUso[producto]) {
                    productoUso[producto] = 0;
                }
                productoUso[producto] += movimiento.cantidad;
            });
            
            const topProductos = Object.entries(productoUso)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const topProductsChartCanvas = document.getElementById('topProductsChart');
            if (topProductsChartCanvas && topProductos.length > 0) {
                const ctx = topProductsChartCanvas.getContext('2d');
                
                topProductsChartInstance = new Chart(ctx, {
                    type: 'horizontalBar',
                    data: {
                        labels: topProductos.map(p => p[0]),
                        datasets: [{
                            label: 'Unidades Utilizadas',
                            data: topProductos.map(p => p[1]),
                            backgroundColor: '#2ecc71',
                            borderColor: '#27ae60',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Unidades'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.raw.toLocaleString()} unidades`;
                                    }
                                }
                            }
                        }
                    }
                });
            } else if (topProductsChartCanvas) {
                topProductsChartCanvas.parentNode.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay datos de productos utilizados para mostrar</p>';
            }
        }

        function actualizarResumenAsignaciones(movimientosFiltrados) {
            const container = document.getElementById('resumenAsignaciones');
            if (!container) return;
            
            const porTipo = {
                entrada: { cantidad: 0, unidades: 0 },
                salida: { cantidad: 0, unidades: 0 },
                ajuste: { cantidad: 0, unidades: 0 },
                reposicion: { cantidad: 0, unidades: 0 }
            };
            
            movimientosFiltrados.forEach(movimiento => {
                if (porTipo[movimiento.tipo]) {
                    porTipo[movimiento.tipo].cantidad++;
                    porTipo[movimiento.tipo].unidades += movimiento.cantidad;
                }
            });
            
            const totalMovimientos = movimientosFiltrados.length;
            const totalUnidades = movimientosFiltrados.reduce((sum, m) => sum + m.cantidad, 0);
            
            let html = `
                <div class="stats-grid">
                    <div class="stat-box">
                        <i class="fas fa-exchange-alt"></i>
                        <div class="stat-content">
                            <h4>Total Movimientos</h4>
                            <p>${totalMovimientos}</p>
                        </div>
                    </div>
                    
                    <div class="stat-box">
                        <i class="fas fa-boxes"></i>
                        <div class="stat-content">
                            <h4>Total Unidades Movidas</h4>
                            <p>${totalUnidades.toLocaleString()}</p>
                        </div>
                    </div>
                </div>
                
                <h4 style="margin-top: 20px;">Desglose por Tipo de Movimiento</h4>
                <div style="margin-top: 10px;">
            `;
            
            Object.keys(porTipo).forEach(tipo => {
                const data = porTipo[tipo];
                if (data.cantidad > 0) {
                    let tipoTexto = '';
                    let color = '';
                    
                    switch(tipo) {
                        case 'entrada':
                            tipoTexto = 'Entradas';
                            color = '#27ae60';
                            break;
                        case 'salida':
                            tipoTexto = 'Salidas';
                            color = '#e74c3c';
                            break;
                        case 'ajuste':
                            tipoTexto = 'Ajustes';
                            color = '#f39c12';
                            break;
                        case 'reposicion':
                            tipoTexto = 'Reposiciones';
                            color = '#9b59b6';
                            break;
                    }
                    
                    html += `
                        <div style="margin-bottom: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px; border-left: 4px solid ${color}">
                            <div style="display: flex; justify-content: space-between;">
                                <strong>${tipoTexto}</strong>
                                <span>${data.cantidad} movimientos</span>
                            </div>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                                Total unidades: ${data.unidades.toLocaleString()}
                            </div>
                        </div>
                    `;
                }
            });
            
            const porDepartamento = {};
            const movimientosSalidas = movimientosFiltrados.filter(m => m.tipo === 'salida');
            
            movimientosSalidas.forEach(movimiento => {
                const dept = movimiento.departamento;
                if (!porDepartamento[dept]) {
                    porDepartamento[dept] = {
                        cantidad: 0,
                        unidades: 0,
                        productos: new Set()
                    };
                }
                porDepartamento[dept].cantidad++;
                porDepartamento[dept].unidades += movimiento.cantidad;
                porDepartamento[dept].productos.add(movimiento.producto);
            });
            
            if (Object.keys(porDepartamento).length > 0) {
                html += `
                    <h4 style="margin-top: 20px;">Asignaciones por Departamento</h4>
                    <div style="margin-top: 10px;">
                `;
                
                Object.keys(porDepartamento).forEach(dept => {
                    const data = porDepartamento[dept];
                    html += `
                        <div style="margin-bottom: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                            <div style="display: flex; justify-content: space-between;">
                                <strong>${dept}</strong>
                                <span>${data.unidades.toLocaleString()} unidades</span>
                            </div>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                                ${data.cantidad} asignaciones | Productos: ${Array.from(data.productos).join(', ')}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            
            doc.setFontSize(16);
            doc.text('Reporte de Inventario - Artículos de Oficina', 14, 15);
            
            doc.setFontSize(10);
            doc.text(`Generado: ${new Date().toLocaleString('es-ES')}`, 14, 23);
            
            const totalProducts = productos.length;
            let totalUnidades = 0;
            let lowStockCount = 0;
            
            productos.forEach(producto => {
                const unidadesTotales = calcularUnidadesTotales(producto);
                const stockMinimoUnidades = producto.stockMinimo * (producto.unidadesPorMedida || 1);
                totalUnidades += unidadesTotales;
                
                if (unidadesTotales < stockMinimoUnidades) {
                    lowStockCount++;
                }
            });
            
            doc.setFontSize(11);
            doc.text('Resumen del Inventario:', 14, 33);
            doc.setFontSize(9);
            doc.text(`Total de productos: ${totalProducts}`, 14, 40);
            doc.text(`Productos con stock bajo: ${lowStockCount}`, 14, 47);
            doc.text(`Stock total: ${totalUnidades.toLocaleString()} unidades`, 14, 54);
            
            const headers = [['#', 'Código', 'Producto', 'Categoría', 'Stock', 'Unidades Totales', 'Unidad', 'Estado']];
            const data = productos.map(p => {
                const codigoNum = p.codigo.split('-')[1] || p.id;
                const unidadesTotales = calcularUnidadesTotales(p);
                const stockMinimoUnidades = p.stockMinimo * (p.unidadesPorMedida || 1);
                
                let estado = '';
                if (unidadesTotales < stockMinimoUnidades) {
                    estado = 'Stock Bajo';
                } else if (unidadesTotales < stockMinimoUnidades * 2) {
                    estado = 'Stock Normal';
                } else {
                    estado = 'Stock Alto';
                }
                
                return [
                    codigoNum,
                    p.codigo,
                    p.nombre,
                    p.categoria.charAt(0).toUpperCase() + p.categoria.slice(1),
                    p.unidad === "UND" ? `${p.stock} ${p.unidad}` : `${p.stock} ${p.unidad}`,
                    unidadesTotales.toLocaleString(),
                    p.unidad,
                    estado
                ];
            });
            
            doc.autoTable({
                head: headers,
                body: data,
                startY: 60,
                theme: 'striped',
                headStyles: { fillColor: [52, 152, 219] },
                margin: { horizontal: 14 }
            });
            
            doc.save(`inventario-oficina-${new Date().toISOString().slice(0,10)}.pdf`);
        }

        function exportarExcel() {
            const productosData = productos.map(p => {
                const unidadesTotales = calcularUnidadesTotales(p);
                const stockMinimoUnidades = p.stockMinimo * (p.unidadesPorMedida || 1);
                
                let estado = '';
                if (unidadesTotales < stockMinimoUnidades) {
                    estado = 'Stock Bajo';
                } else if (unidadesTotales < stockMinimoUnidades * 2) {
                    estado = 'Stock Normal';
                } else {
                    estado = 'Stock Alto';
                }
                
                const codigoNum = p.codigo.split('-')[1] || p.id;
                
                return {
                    '#': codigoNum,
                    'Código': p.codigo,
                    'Producto': p.nombre,
                    'Categoría': p.categoria.charAt(0).toUpperCase() + p.categoria.slice(1),
                    'Stock': p.unidad === "UND" ? `${p.stock} ${p.unidad}` : `${p.stock} ${p.unidad}`,
                    'Unidades Totales': unidadesTotales,
                    'Unidad': p.unidad,
                    'Unidades por Medida': p.unidadesPorMedida || 1,
                    'Stock Mínimo': p.unidad === "UND" ? `${p.stockMinimo} ${p.unidad}` : `${p.stockMinimo} ${p.unidad}`,
                    'Stock Mínimo (Unidades)': stockMinimoUnidades,
                    'Estado': estado,
                    'Descripción': p.descripcion || ''
                };
            });
            
            const movimientosData = movimientos.map(m => {
                let tipo = '';
                switch(m.tipo) {
                    case 'entrada':
                        tipo = 'Entrada';
                        break;
                    case 'salida':
                        tipo = 'Salida';
                        break;
                    case 'ajuste':
                        tipo = 'Ajuste';
                        break;
                    case 'reposicion':
                        tipo = 'Reposición';
                        break;
                    default:
                        tipo = m.tipo;
                }
                
                return {
                    'Fecha y Hora': m.fechaHora,
                    'Tipo': tipo,
                    'Producto': m.producto,
                    'Cantidad (Unidades)': m.cantidad,
                    'Departamento': m.departamento,
                    'Usuario': m.usuario,
                    'Observaciones': m.observaciones || '',
                    'Responsable': m.responsable
                };
            });
            
            const wsProductos = XLSX.utils.json_to_sheet(productosData);
            const wsMovimientos = XLSX.utils.json_to_sheet(movimientosData);
            
            const wscolsProductos = [
                {wch: 5},
                {wch: 10},
                {wch: 30},
                {wch: 12},
                {wch: 15},
                {wch: 15},
                {wch: 8},
                {wch: 15},
                {wch: 15},
                {wch: 20},
                {wch: 12},
                {wch: 40}
            ];
            wsProductos['!cols'] = wscolsProductos;
            
            const wscolsMovimientos = [
                {wch: 20},
                {wch: 10},
                {wch: 25},
                {wch: 15},
                {wch: 15},
                {wch: 20},
                {wch: 30},
                {wch: 15}
            ];
            wsMovimientos['!cols'] = wscolsMovimientos;
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, wsProductos, 'Inventario');
            XLSX.utils.book_append_sheet(wb, wsMovimientos, 'Movimientos');
            
            XLSX.writeFile(wb, `inventario-completo-${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        function exportarInventarioActualExcel() {
            const productosData = productos.map(p => {
                const unidadesTotales = calcularUnidadesTotales(p);
                const stockMinimoUnidades = p.stockMinimo * (p.unidadesPorMedida || 1);
                
                let estado = '';
                let prioridad = '';
                
                if (unidadesTotales === 0) {
                    estado = 'AGOTADO';
                    prioridad = 'URGENTE';
                } else if (unidadesTotales < stockMinimoUnidades) {
                    estado = 'BAJO';
                    prioridad = 'ALTA';
                } else if (unidadesTotales < stockMinimoUnidades * 2) {
                    estado = 'NORMAL';
                    prioridad = 'MEDIA';
                } else {
                    estado = 'ALTO';
                    prioridad = 'BAJA';
                }
                
                const faltan = Math.max(0, stockMinimoUnidades - unidadesTotales);
                
                return {
                    'Código': p.codigo,
                    'Producto': p.nombre,
                    'Categoría': p.categoria.charAt(0).toUpperCase() + p.categoria.slice(1),
                    'Stock Actual': p.stock,
                    'Unidad': p.unidad,
                    'Unidades por Medida': p.unidadesPorMedida || 1,
                    'Unidades Totales': unidadesTotales,
                    'Stock Mínimo': p.stockMinimo,
                    'Stock Mínimo (Unidades)': stockMinimoUnidades,
                    'Faltan (Unidades)': faltan,
                    'Estado': estado,
                    'Prioridad Reposición': prioridad,
                    'Última Actualización': new Date().toLocaleDateString('es-ES')
                };
            });
            
            productosData.sort((a, b) => {
                const prioridadOrden = { 'URGENTE': 1, 'ALTA': 2, 'MEDIA': 3, 'BAJA': 4 };
                return prioridadOrden[a['Prioridad Reposición']] - prioridadOrden[b['Prioridad Reposición']];
            });
            
            const ws = XLSX.utils.json_to_sheet(productosData);
            
            const wscols = [
                {wch: 10},
                {wch: 30},
                {wch: 12},
                {wch: 12},
                {wch: 8},
                {wch: 15},
                {wch: 15},
                {wch: 12},
                {wch: 20},
                {wch: 15},
                {wch: 10},
                {wch: 18},
                {wch: 20}
            ];
            ws['!cols'] = wscols;
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Inventario Actual');
            
            XLSX.writeFile(wb, `inventario-actual-${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        function exportarReporteExcel() {
            const reportType = document.getElementById('reportType').value;
            let nombreReporte = '';
            let datos = [];
            
            if (reportType === 'productos') {
                nombreReporte = 'Reporte de Productos';
                
                datos = productos.map(p => {
                    const unidades = calcularUnidadesTotales(p);
                    const minimo = p.stockMinimo * (p.unidadesPorMedida || 1);
                    const porcentaje = Math.round((unidades / minimo) * 100);
                    
                    return {
                        'Código': p.codigo,
                        'Producto': p.nombre,
                        'Categoría': p.categoria,
                        'Stock Actual': p.stock,
                        'Unidad': p.unidad,
                        'Unidades Totales': unidades,
                        'Stock Mínimo': p.stockMinimo,
                        'Stock Mínimo (Unidades)': minimo,
                        'Porcentaje Stock': `${porcentaje}%`,
                        'Estado': unidades < minimo ? 'BAJO' : unidades < minimo * 2 ? 'NORMAL' : 'ALTO',
                        'Necesita Reposición': unidades < minimo ? 'SÍ' : 'NO'
                    };
                });
            } else {
                nombreReporte = 'Reporte de Movimientos';
                
                let movimientosFiltrados = [];
                if (reportType === 'mensual') {
                    const month = parseInt(document.getElementById('reportMonth').value);
                    const year = parseInt(document.getElementById('reportYear').value);
                    movimientosFiltrados = movimientos.filter(m => {
                        const fecha = new Date(m.fechaHora);
                        return fecha.getMonth() + 1 === month && fecha.getFullYear() === year;
                    });
                    nombreReporte += ` - ${document.getElementById('reportMonth').options[document.getElementById('reportMonth').selectedIndex].text} ${year}`;
                } else if (reportType === 'anual') {
                    const year = parseInt(document.getElementById('reportYear').value);
                    movimientosFiltrados = movimientos.filter(m => {
                        const fecha = new Date(m.fechaHora);
                        return fecha.getFullYear() === year;
                    });
                    nombreReporte += ` - Año ${year}`;
                } else {
                    movimientosFiltrados = movimientos;
                }
                
                datos = movimientosFiltrados.map(m => {
                    return {
                        'Fecha y Hora': m.fechaHora,
                        'Tipo': m.tipo.toUpperCase(),
                        'Producto': m.producto,
                        'Cantidad (Unidades)': m.cantidad,
                        'Departamento': m.departamento,
                        'Usuario': m.usuario,
                        'Observaciones': m.observaciones || '',
                        'Responsable': m.responsable
                    };
                });
            }
            
            const ws = XLSX.utils.json_to_sheet(datos);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Reporte');
            
            XLSX.writeFile(wb, `${nombreReporte}-${new Date().toISOString().slice(0,10)}.xlsx`);
        }
    </script>
</body>
</html>
